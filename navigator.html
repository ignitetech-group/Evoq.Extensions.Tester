<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evoq Extensions Test Navigator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --bg-card: #131316;
            --bg-elevated: #1c1c21;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.08);
            --border-emphasis: rgba(255, 255, 255, 0.12);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            --text-muted: #52525b;
            --accent-primary: #6366f1;
            --accent-primary-soft: rgba(99, 102, 241, 0.15);
            --accent-secondary: #22d3ee;
            --status-success: #22c55e;
            --status-success-soft: rgba(34, 197, 94, 0.12);
            --status-error: #ef4444;
            --status-error-soft: rgba(239, 68, 68, 0.12);
            --status-warning: #f59e0b;
            --status-warning-soft: rgba(245, 158, 11, 0.12);
            --priority-high: #f43f5e;
            --priority-medium: #f59e0b;
            --priority-low: #6b7280;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-fast: 150ms ease;
            --transition-base: 200ms ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Compact Top Bar */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 12px 32px;
        }

        .top-bar-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, #818cf8 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .source-tag {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .source-tag span { color: var(--accent-secondary); }

        /* Inline Stats - Key metrics only */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.success { color: var(--status-success); }
        .stat-value.error { color: var(--status-error); }
        .stat-value.accent { color: var(--accent-primary); }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stat-divider {
            width: 1px;
            height: 24px;
            background: var(--border-default);
        }

        /* Progress indicator inline */
        .progress-ring {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 4;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--status-success);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        /* Main Content */
        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px 32px 40px;
        }

        /* Controls Row - Compact */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 220px;
            max-width: 320px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            transition: var(--transition-fast);
        }

        .search-box input::placeholder { color: var(--text-muted); }
        .search-box input:focus { outline: none; border-color: var(--accent-primary); }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            width: 16px;
            height: 16px;
        }

        .filter-group {
            display: flex;
            gap: 4px;
            padding: 3px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .filter-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-btn:hover { color: var(--text-secondary); }
        .filter-btn.active { background: var(--bg-elevated); color: var(--text-primary); }

        .filter-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .filter-dot.high { background: var(--priority-high); }
        .filter-dot.medium { background: var(--priority-medium); }
        .filter-dot.low { background: var(--priority-low); }

        .controls-right {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .btn-icon {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-tertiary);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-icon:hover { color: var(--text-secondary); border-color: var(--border-emphasis); }
        .btn-icon.active { background: var(--accent-primary-soft); color: var(--accent-primary); border-color: var(--accent-primary); }

        .btn-icon .badge-count {
            background: var(--accent-primary);
            color: white;
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .btn-icon .badge-count.empty { display: none; }

        .btn-refresh {
            padding: 8px 14px;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-refresh:hover { background: #4f46e5; }
        .btn-refresh.loading { opacity: 0.7; pointer-events: none; }

        /* Discarded Drawer - Hidden by default */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-base);
        }

        .drawer-overlay.active { opacity: 1; visibility: visible; }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 380px;
            max-width: 90vw;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-subtle);
            z-index: 201;
            transform: translateX(100%);
            transition: transform var(--transition-base);
            display: flex;
            flex-direction: column;
        }

        .drawer.active { transform: translateX(0); }

        .drawer-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .drawer-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .drawer-close {
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition-fast);
        }

        .drawer-close:hover { color: var(--text-primary); border-color: var(--border-emphasis); }

        .drawer-stats {
            padding: 16px 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .drawer-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .drawer-stat-value {
            font-size: 20px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .drawer-stat-value.success { color: var(--status-success); }
        .drawer-stat-value.error { color: var(--status-error); }
        .drawer-stat-value.muted { color: var(--text-muted); }

        .drawer-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

        .drawer-actions {
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .btn-ghost {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-ghost:hover { border-color: var(--border-emphasis); color: var(--text-secondary); }
        .btn-ghost.danger:hover { border-color: var(--status-error); color: var(--status-error); }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .drawer-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            margin-bottom: 4px;
        }

        .drawer-list-item:hover { background: var(--bg-tertiary); }

        .drawer-list-item-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .drawer-list-item-ext {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 12px;
        }

        .drawer-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Results Grid - THE PRIMARY CONTENT */
        .results-section { margin-top: 0; }

        .repository { margin-bottom: 32px; }

        .repo-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
        }

        .repo-name {
            font-size: 15px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .repo-count {
            font-size: 11px;
            color: var(--text-tertiary);
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            margin-left: auto;
        }

        .type-group { margin-bottom: 20px; }

        .type-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .type-icon {
            width: 20px;
            height: 20px;
            background: var(--accent-primary-soft);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
        }

        .extensions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 12px;
        }

        /* Extension Card - Compact */
        .extension-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: var(--transition-base);
        }

        .extension-card:hover {
            border-color: var(--border-emphasis);
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .card-info { flex: 1; min-width: 0; }

        .extension-name {
            font-size: 13px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .extension-desc {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .badge-priority { background: var(--bg-tertiary); }
        .badge-priority.high { color: var(--priority-high); }
        .badge-priority.medium { color: var(--priority-medium); }
        .badge-priority.low { color: var(--priority-low); }

        .badge-pass { background: var(--status-success-soft); color: var(--status-success); }
        .badge-warning { background: var(--status-warning-soft); color: var(--status-warning); }
        .badge-fail { background: var(--status-error-soft); color: var(--status-error); }

        .expand-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            font-size: 10px;
            flex-shrink: 0;
        }

        .extension-card:hover .expand-icon {
            color: var(--text-secondary);
            background: var(--bg-elevated);
        }

        .extension-card.expanded .expand-icon {
            transform: rotate(180deg);
            background: var(--accent-primary-soft);
            color: var(--accent-primary);
        }

        .card-content {
            display: none;
            border-top: 1px solid var(--border-subtle);
        }

        .extension-card.expanded .card-content { display: block; }

        /* Test Items */
        .test-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .test-item:last-child { border-bottom: none; }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-name {
            font-weight: 500;
            font-size: 12px;
            color: var(--text-primary);
        }

        .test-actions { display: flex; gap: 6px; align-items: center; }

        .btn-sm {
            padding: 5px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-sm:hover { color: var(--text-secondary); border-color: var(--border-emphasis); }

        /* Scenarios */
        .scenarios-list { margin-top: 6px; }

        .scenario-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            margin-bottom: 3px;
            font-size: 12px;
            transition: var(--transition-fast);
        }

        .scenario-item.pass { background: var(--status-success-soft); }
        .scenario-item.fail { background: var(--status-error-soft); }
        .scenario-item.discarded { opacity: 0.5; background: var(--bg-tertiary); }
        .scenario-item.discarded .scenario-name { text-decoration: line-through; }

        .scenario-status {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            flex-shrink: 0;
        }

        .scenario-item.pass .scenario-status { background: var(--status-success); color: white; }
        .scenario-item.fail .scenario-status { background: var(--status-error); color: white; }

        .scenario-name { flex: 1; color: var(--text-primary); }

        .scenario-steps {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .scenario-discard-btn {
            width: 20px;
            height: 20px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .scenario-item:hover .scenario-discard-btn { opacity: 1; }
        .scenario-discard-btn:hover { background: var(--bg-elevated); color: var(--text-secondary); }
        .scenario-discard-btn.active { opacity: 1; background: var(--accent-primary); border-color: var(--accent-primary); color: white; }

        .scenario-issues { padding: 3px 10px 3px 34px; margin-bottom: 3px; }

        .issue-tag {
            display: inline-block;
            font-size: 10px;
            color: var(--status-warning);
            background: var(--status-warning-soft);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            margin-right: 4px;
        }

        /* Screenshots */
        .screenshots {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .screenshot-thumb {
            width: 48px;
            height: 36px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 2px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition-fast);
            background: var(--bg-tertiary);
        }

        .screenshot-thumb:hover { border-color: var(--accent-primary); }

        .screenshot-thumb img { width: 100%; height: 100%; object-fit: cover; }

        .more-badge {
            width: 48px;
            height: 36px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 40px;
        }

        .lightbox.active { display: flex; }

        .lightbox-content { max-width: 90%; max-height: 80vh; position: relative; }

        .lightbox-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            transition: var(--transition-fast);
        }

        .lightbox-close:hover { background: var(--bg-tertiary); }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: none;
        }

        .lightbox-nav button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
            pointer-events: auto;
            transition: var(--transition-fast);
        }

        .lightbox-nav button:hover { background: var(--accent-primary); border-color: var(--accent-primary); }

        .lightbox-caption {
            color: var(--text-tertiary);
            margin-top: 16px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Report Modal */
        .report-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 24px;
        }

        .report-modal.active { display: flex; flex-direction: column; }

        .report-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            border: 1px solid var(--border-subtle);
            border-bottom: none;
        }

        .report-modal-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .report-modal-actions { display: flex; gap: 8px; }

        .report-modal-content {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow-y: auto;
            border: 1px solid var(--border-subtle);
            border-top: none;
            padding: 20px;
        }

        /* JSON Detail Styles */
        .json-detail { color: var(--text-primary); }

        .json-meta { margin-bottom: 20px; }

        .json-meta h2 { font-size: 18px; font-weight: 600; margin-bottom: 6px; }

        .json-meta p { color: var(--text-tertiary); font-size: 13px; margin-bottom: 10px; }

        .json-meta-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 11px;
            color: var(--text-muted);
        }

        .json-meta-row strong { color: var(--text-secondary); }

        .json-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .summary-stat {
            text-align: center;
            padding: 16px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
        }

        .summary-stat .num {
            display: block;
            font-size: 28px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1;
        }

        .summary-stat .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 6px;
        }

        .summary-stat.pass .num { color: var(--status-success); }
        .summary-stat.fail .num { color: var(--status-error); }
        .summary-stat.total .num { color: var(--accent-primary); }
        .summary-stat.rate-success .num { color: var(--status-success); }
        .summary-stat.rate-warning .num { color: var(--status-warning); }
        .summary-stat.rate-error .num { color: var(--status-error); }

        .json-scenarios h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px;
            color: var(--text-primary);
        }

        .json-scenario {
            margin-bottom: 14px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .json-scenario.pass { border-left: 3px solid var(--status-success); }
        .json-scenario.fail { border-left: 3px solid var(--status-error); }
        .json-scenario.discarded { opacity: 0.5; }
        .json-scenario.discarded .scenario-title { text-decoration: line-through; }

        .scenario-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: var(--bg-tertiary);
        }

        .scenario-header .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }

        .json-scenario.pass .scenario-header .status-icon { background: var(--status-success); color: white; }
        .json-scenario.fail .scenario-header .status-icon { background: var(--status-error); color: white; }

        .scenario-header .scenario-title { flex: 1; font-weight: 500; font-size: 13px; }

        .status-badge {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.pass { background: var(--status-success-soft); color: var(--status-success); }
        .status-badge.fail { background: var(--status-error-soft); color: var(--status-error); }

        .detail-discard-btn {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .detail-discard-btn:hover { background: var(--bg-elevated); color: var(--text-secondary); }
        .detail-discard-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }

        .scenario-steps-detail { padding: 14px; }

        .step {
            display: flex;
            gap: 14px;
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        .step-num {
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content { flex: 1; font-size: 12px; }
        .step-content > div { margin-bottom: 4px; }
        .step-content strong { color: var(--text-muted); font-weight: 500; }
        .step-action { color: var(--text-primary); }
        .step-expected { color: var(--accent-secondary); }
        .step-actual { color: var(--text-secondary); }

        .step-screenshot-container {
            margin-top: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 8px;
        }

        .step-screenshot-img {
            max-width: 100%;
            max-height: 250px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid var(--border-subtle);
        }

        .step-screenshot-img:hover { border-color: var(--accent-primary); }

        .step-screenshot-name {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .scenario-issues-detail {
            padding: 14px;
            background: var(--status-warning-soft);
            border-top: 1px solid var(--border-subtle);
        }

        .scenario-issues-detail strong { color: var(--status-warning); font-size: 11px; }
        .scenario-issues-detail ul { margin: 6px 0 0 18px; }
        .scenario-issues-detail li { color: var(--status-warning); font-size: 12px; margin-bottom: 3px; }

        .json-observations {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .json-observations h3 { margin-bottom: 10px; font-size: 13px; }
        .json-observations ul { margin: 0 0 0 18px; }
        .json-observations li { color: var(--text-secondary); font-size: 12px; margin-bottom: 4px; }

        /* States */
        .loading-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-tertiary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .error-state {
            text-align: center;
            padding: 60px 40px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }

        .error-state h3 { color: var(--status-error); margin-bottom: 10px; font-size: 15px; }
        .error-state p { color: var(--text-tertiary); font-size: 13px; }

        .error-state code {
            display: block;
            background: var(--bg-tertiary);
            padding: 14px;
            border-radius: var(--radius-md);
            margin-top: 14px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .top-bar { padding: 12px 20px; }
            .top-bar-content { flex-wrap: wrap; }
            .stats-bar { gap: 16px; }
            .main-content { padding: 16px 20px; }
            .extensions-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 640px) {
            .top-bar-content { flex-direction: column; align-items: flex-start; gap: 12px; }
            .stats-bar { width: 100%; justify-content: space-between; margin-left: 0; }
            .controls { flex-direction: column; }
            .search-box { max-width: 100%; }
            .controls-right { width: 100%; justify-content: flex-end; }
        }

        /* SVG Icons */
        .icon {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body>
    <!-- Compact Top Bar -->
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="brand">
                <div class="brand-icon">
                    <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: white;">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </div>
                <span class="brand-text">Test Navigator</span>
            </div>
            <div class="source-tag">Source: <span id="folder-name">...</span></div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-value success" id="stat-passed">-</span>
                    <span class="stat-label">Passed</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-value error" id="stat-failed">-</span>
                    <span class="stat-label">Failed</span>
                </div>
                <div class="stat-divider"></div>
                <div class="progress-ring" id="progressRing" title="Pass Rate">
                    <svg viewBox="0 0 40 40">
                        <circle class="progress-ring-bg" cx="20" cy="20" r="16"/>
                        <circle class="progress-ring-fill" cx="20" cy="20" r="16"
                                stroke-dasharray="100.5" stroke-dashoffset="100.5" id="progressFill"/>
                    </svg>
                    <span class="progress-ring-text" id="stat-passrate">-%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Controls Row -->
        <div class="controls">
            <div class="search-box">
                <svg class="search-icon icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Search extensions...">
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-priority="all">All</button>
                <button class="filter-btn" data-priority="High"><span class="filter-dot high"></span>High</button>
                <button class="filter-btn" data-priority="Medium"><span class="filter-dot medium"></span>Med</button>
                <button class="filter-btn" data-priority="Low"><span class="filter-dot low"></span>Low</button>
            </div>
            <div class="controls-right">
                <button class="btn-icon" id="discardedToggle" onclick="toggleDrawer()" title="Review discarded scenarios">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                    </svg>
                    Review
                    <span class="badge-count empty" id="discardedBadge">0</span>
                </button>
                <button class="btn-refresh" onclick="loadData()">
                    <svg class="btn-icon-svg icon" viewBox="0 0 24 24">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Results - PRIMARY CONTENT -->
        <div id="content" class="results-section">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading test results...</p>
            </div>
        </div>
    </div>

    <!-- Discarded Drawer (Hidden by default) -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="toggleDrawer()"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <span class="drawer-title">Review Progress</span>
            <button class="drawer-close" onclick="toggleDrawer()">&times;</button>
        </div>
        <div class="drawer-stats">
            <div class="drawer-stat">
                <div class="drawer-stat-value success" id="review-passed">0</div>
                <div class="drawer-stat-label">Passed</div>
            </div>
            <div class="drawer-stat">
                <div class="drawer-stat-value error" id="review-failed">0</div>
                <div class="drawer-stat-label">Failed</div>
            </div>
            <div class="drawer-stat">
                <div class="drawer-stat-value muted" id="review-discarded">0</div>
                <div class="drawer-stat-label">Discarded</div>
            </div>
        </div>
        <div class="drawer-actions">
            <button class="btn-ghost" onclick="saveDiscardStatus()" title="Save discard status to file for sharing">Save</button>
            <button class="btn-ghost" onclick="exportReviewStatus()">Export</button>
            <button class="btn-ghost" onclick="importReviewStatus()">Import</button>
            <button class="btn-ghost danger" onclick="clearAllStatus()">Clear</button>
        </div>
        <div class="drawer-content" id="drawer-content">
            <div class="drawer-empty">No discarded scenarios</div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <div class="lightbox-content">
            <img id="lightbox-img" src="" alt="">
        </div>
        <div class="lightbox-nav">
            <button onclick="navigateLightbox(-1)">&larr;</button>
            <button onclick="navigateLightbox(1)">&rarr;</button>
        </div>
        <div class="lightbox-caption" id="lightbox-caption"></div>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="reportModal">
        <div class="report-modal-header">
            <span class="report-modal-title" id="reportModalTitle">Test Report</span>
            <div class="report-modal-actions">
                <button class="btn-ghost" onclick="openReportNewTab()">Open in Tab</button>
                <button class="btn-ghost danger" onclick="closeReportModal()">Close</button>
            </div>
        </div>
        <div class="report-modal-content" id="reportModalContent"></div>
    </div>

    <script>
        const EXTENSIONS_META = {
            'DotNetNuke.Professional': { repository: 'Dnn.Evoq.Basic', type: 'Core Library', description: 'DotNetNuke Professional', priority: 'N/A' },
            'Evoq.Library': { repository: 'Dnn.Evoq.Basic', type: 'Core Library', description: 'Evoq Library', priority: 'N/A' },
            'Evoq.Content.Library': { repository: 'Dnn.Evoq.Basic', type: 'Core Library', description: 'Evoq Content Library', priority: 'N/A' },
            'Evoq.Social.Mechanics': { repository: 'Dnn.Evoq.Basic', type: 'Core Library', description: 'Mechanics', priority: 'N/A' },
            'Evoq.PortableService.Library': { repository: 'Dnn.Evoq.Basic', type: 'Core Library', description: 'Evoq.PortableService.Library', priority: 'N/A' },
            'DotNetNuke.Telerik.Web.Design': { repository: 'Dnn.Evoq.Basic', type: 'Core Library', description: 'DotNetNuke Telerik Web Design Components', priority: 'N/A' },
            'DNN_HTML': { repository: 'Dnn.Evoq.Basic', type: 'Module', description: 'HTML Pro', priority: 'High' },
            'ContentLayout': { repository: 'Dnn.Evoq.Basic', type: 'Module', description: 'ContentLayout', priority: 'High' },
            'DotNetNuke.Professional.SearchCrawler': { repository: 'Dnn.Evoq.Basic', type: 'Module', description: 'Search Crawler Admin', priority: 'High' },
            'Evoq.GoogleAnalyticsConnector': { repository: 'Dnn.Evoq.Basic', type: 'Connector', description: 'Evoq Google Analytics Connector', priority: 'High' },
            'Evoq.AmazonS3Connector': { repository: 'Dnn.Evoq.Basic', type: 'Connector', description: 'Evoq AmazonS3 Connector', priority: 'Low' },
            'Evoq.UNCConnector': { repository: 'Dnn.Evoq.Basic', type: 'Connector', description: 'Evoq UNC Connector', priority: 'Low' },
            'Evoq.KayakoMessengerConnector': { repository: 'Dnn.Evoq.Basic', type: 'Connector', description: 'Kayako Messenger Connector', priority: 'Medium' },
            'DNNPro_ActiveDirectoryAuthentication': { repository: 'Dnn.Evoq.Basic', type: 'Authentication Provider', description: 'Active Directory Authentication', priority: 'High' },
            'DotNetNuke.Professional.FolderProviders': { repository: 'Dnn.Evoq.Basic', type: 'Folder Provider', description: 'Professional Folder Providers (S3, Azure, UNC)', priority: 'Medium' },
            'DotNetNuke.Providers.IFilterServiceClientProvider': { repository: 'Dnn.Evoq.Basic', type: 'Other Provider', description: 'IFilter Service Client Provider', priority: 'Medium' },
            'Provider.BigSitemapProvider': { repository: 'Dnn.Evoq.Basic', type: 'Other Provider', description: 'Big Sitemap Provider', priority: 'Low' },
            'd3': { repository: 'Dnn.Evoq.Basic', type: 'JavaScript Library', description: 'D3 JavaScript Library', priority: 'Low' },
            'Cavalier': { repository: 'Dnn.Evoq.Basic', type: 'Skin', description: 'Cavalier Skin', priority: 'Low' },
            'DotNetNuke.Enterprise': { repository: 'Dnn.Evoq.Content', type: 'Core Library', description: 'DotNetNuke Enterprise', priority: 'N/A' },
            'DotNetNuke.Enterprise.ContentPersonalization': { repository: 'Dnn.Evoq.Content', type: 'Core Library', description: 'Content Personalization', priority: 'N/A' },
            'Evoq.Revisions': { repository: 'Dnn.Evoq.Content', type: 'Core Library', description: 'Revisions API', priority: 'N/A' },
            'Publisher': { repository: 'Dnn.Evoq.Content', type: 'Module', description: 'Publisher (Blog/Content Publishing)', priority: 'High' },
            'DotNetNuke.Enterprise.HubspotForms': { repository: 'Dnn.Evoq.Content', type: 'Module', description: 'HubSpot Forms', priority: 'Low' },
            'DotNetNuke.Enterprise.MarketoForms': { repository: 'Dnn.Evoq.Content', type: 'Module', description: 'Marketo Forms', priority: 'Low' },
            'Evoq.BoxConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq Box Connector', priority: 'Low' },
            'Evoq.DisqusConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq Disqus Connector', priority: 'Low' },
            'Evoq.DropboxConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq Dropbox Connector', priority: 'Low' },
            'Evoq.Content.GoogleAnalyticsConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq Content Google Analytics Connector', priority: 'High' },
            'Evoq.GoogleTagManagerConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq Google Tag Manager Connector', priority: 'High' },
            'Evoq.HubspotConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq HubSpot Connector', priority: 'Low' },
            'Evoq.MarketoConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Evoq Marketo Connector', priority: 'Low' },
            'Evoq.OptimizelyConnector': { repository: 'Dnn.Evoq.Content', type: 'Connector', description: 'Optimizely Connector', priority: 'Low' },
            'DotNetNuke.Enterprise.FolderProviders': { repository: 'Dnn.Evoq.Content', type: 'Folder Provider', description: 'Enterprise Folder Providers (Box, Dropbox)', priority: 'Low' },
            'Evoq.Social.SocialLibrary': { repository: 'Dnn.Evoq.Social', type: 'Core Library', description: 'SocialLibrary API', priority: 'N/A' },
            'Evoq.Social.SocialSolution': { repository: 'Dnn.Evoq.Social', type: 'Core Library', description: 'SocialSolution Library', priority: 'N/A' },
            'Evoq.Social.Analytics': { repository: 'Dnn.Evoq.Social', type: 'Core Library', description: 'Analytics Library', priority: 'N/A' },
            'Evoq.Social.Revisions': { repository: 'Dnn.Evoq.Social', type: 'Core Library', description: 'Social Revisions', priority: 'N/A' },
            'Evoq.Social.Activities': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Activities (User Badges)', priority: 'Medium' },
            'Evoq.Social.ActivityStream': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Activity Stream', priority: 'High' },
            'Evoq.Social.Answers': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Answers (Q&A)', priority: 'Medium' },
            'Evoq.Social.Blogs': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Blogs', priority: 'Medium' },
            'Evoq.Social.Discussions': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Discussions (Forums)', priority: 'Medium' },
            'Evoq.Social.Ideas': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Ideas', priority: 'Medium' },
            'Evoq.Social.Wiki': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Wiki', priority: 'High' },
            'Evoq.Social.ProfileDashboard': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Profile Dashboard (Community Dashboard)', priority: 'Medium' },
            'Evoq.Social.Leaderboard': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Leaderboard', priority: 'Medium' },
            'Evoq.Social.MechanicsAdmin': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Mechanics Management', priority: 'Medium' },
            'DotNetNuke.Professional.GameCenter': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'GameCenter', priority: 'Low' },
            'Evoq.Social.GroupSpaces': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Group Spaces', priority: 'Medium' },
            'Evoq.Social.GroupDirectory': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Group Directory', priority: 'Medium' },
            'Evoq.Social.MyStatus': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'My Status', priority: 'Medium' },
            'Evoq.Social.RelatedContent': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Related Content', priority: 'Medium' },
            'Evoq.Social.SocialEvents': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Social Events', priority: 'Medium' },
            'Evoq.Social.SocialShare': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Social Share', priority: 'Medium' },
            'Evoq.Social.Boards': { repository: 'Dnn.Evoq.Social', type: 'Module', description: 'Boards', priority: 'Medium' },
            'Evoq.Social.FacebookConnector': { repository: 'Dnn.Evoq.Social', type: 'Connector', description: 'Facebook Connector', priority: 'Low' },
            'Evoq.Social.LinkedInConnector': { repository: 'Dnn.Evoq.Social', type: 'Connector', description: 'LinkedIn Connector', priority: 'Low' },
            'Evoq.Social.TwitterConnector': { repository: 'Dnn.Evoq.Social', type: 'Connector', description: 'Twitter Connector', priority: 'Low' },
            'Evoq.Engage.ZendeskConnector': { repository: 'Dnn.Evoq.Social', type: 'Connector', description: 'Zendesk Connector', priority: 'Low' },
            'Evoq.Engage.ZendeskTickets': { repository: 'Dnn.Evoq.Social', type: 'Support Module', description: 'Zendesk Tickets', priority: 'Low' },
            'Evoq.PersonaBar.Library': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'Core Library', description: 'Evoq PersonaBar Library', priority: 'N/A' },
            'Evoq.PersonaBar.UI': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Evoq PersonaBar UI', priority: 'High' },
            'Evoq.PersonaBar.AccountSettings': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Account Settings', priority: 'High' },
            'Evoq.PersonaBar.Assets': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Assets Management', priority: 'High' },
            'Evoq.PersonaBar.PageAnalytics': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Page Analytics', priority: 'Medium' },
            'Evoq.PersonaBar.Pages': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Pages Management (Enhanced)', priority: 'High' },
            'Evoq.PersonaBar.Recyclebin': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Recycle Bin (Enhanced)', priority: 'Medium' },
            'Evoq.PersonaBar.Servers': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Servers Management', priority: 'Medium' },
            'Evoq.PersonaBar.Sites': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Sites Management', priority: 'Medium' },
            'Evoq.PersonaBar.SiteSettings': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Site Settings', priority: 'High' },
            'Evoq.PersonaBar.Templates': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Templates Management', priority: 'High' },
            'Evoq.PersonaBar.UrlManagement': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'URL Management', priority: 'High' },
            'Evoq.PersonaBar.Users': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Users Management (Enhanced)', priority: 'High' },
            'Evoq.PersonaBar.Workflow': { repository: 'Dnn.AdminExperience.Evoq.Basic', type: 'PersonaBar Module', description: 'Workflow Management', priority: 'High' },
            'Evoq.PersonaBar.CommunityAnalytics': { repository: 'Dnn.AdminExperience.Evoq.Engage', type: 'PersonaBar Module', description: 'Community Analytics', priority: 'High' },
            'Evoq.PersonaBar.CommunitySettings': { repository: 'Dnn.AdminExperience.Evoq.Engage', type: 'PersonaBar Module', description: 'Community Settings', priority: 'High' },
            'Evoq.PersonaBar.Gamification': { repository: 'Dnn.AdminExperience.Evoq.Engage', type: 'PersonaBar Module', description: 'Gamification Management', priority: 'Medium' }
        };

        const TYPE_ICONS = {
            'Module': 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4',
            'Connector': 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1',
            'PersonaBar Module': 'M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z',
            'Core Library': 'M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z',
            'Folder Provider': 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z',
            'Authentication Provider': 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z',
            'Other Provider': 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z',
            'Skin': 'M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01',
            'JavaScript Library': 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4',
            'Support Module': 'M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z'
        };

        let currentData = null;
        let outputFolder = '';
        let currentLightboxImages = [];
        let currentLightboxIndex = 0;

        // Drawer toggle
        function toggleDrawer() {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('drawerOverlay');
            const toggle = document.getElementById('discardedToggle');

            const isActive = drawer.classList.contains('active');
            drawer.classList.toggle('active', !isActive);
            overlay.classList.toggle('active', !isActive);
            toggle.classList.toggle('active', !isActive);
        }

        function loadData() {
            const btn = document.querySelector('.btn-refresh');
            btn.classList.add('loading');

            const oldScript = document.getElementById('manifest-script');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'manifest-script';
            script.src = 'manifest.js?t=' + Date.now();

            script.onload = () => {
                // Also load discard_status.js
                const discardScript = document.createElement('script');
                discardScript.src = 'discard_status.js?t=' + Date.now();
                discardScript.onload = () => {
                    // Merge saved discard status with localStorage
                    if (window.DISCARD_STATUS && Object.keys(window.DISCARD_STATUS).length > 0) {
                        const current = getAllStatus();
                        const merged = { ...window.DISCARD_STATUS, ...current };
                        saveAllStatus(merged);
                    }
                    finishLoading();
                };
                discardScript.onerror = () => {
                    // No discard_status.js file, that's fine
                    finishLoading();
                };
                document.body.appendChild(discardScript);
            };

            function finishLoading() {
                btn.classList.remove('loading');
                if (window.MANIFEST_DATA) {
                    currentData = window.MANIFEST_DATA;
                    outputFolder = currentData.outputFolder || 'Output 1';
                    document.getElementById('folder-name').textContent = outputFolder;
                    renderContent(currentData);
                } else {
                    showError();
                }
            }

            script.onerror = () => {
                btn.classList.remove('loading');
                showError();
            };

            document.head.appendChild(script);
        }

        function showError() {
            document.getElementById('content').innerHTML = `
                <div class="error-state">
                    <h3>Could not load manifest.js</h3>
                    <p>Run this command to generate it:</p>
                    <code>python3 update_manifest.py</code>
                </div>
            `;
        }

        function getPassRateColor(percent) {
            if (percent >= 90) return 'var(--status-success)';  // Green: 90%+
            if (percent >= 70) return 'var(--status-warning)';  // Yellow: 70-89%
            return 'var(--status-error)';                        // Red: below 70%
        }

        function updateProgressRing(percent) {
            const circumference = 2 * Math.PI * 16; // r=16
            const offset = circumference - (percent / 100) * circumference;
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('stat-passrate');
            
            fill.style.strokeDashoffset = offset;
            fill.style.stroke = getPassRateColor(percent);
            text.style.color = getPassRateColor(percent);
        }

        function renderContent(data) {
            document.getElementById('stat-passed').textContent = data.stats.passed || 0;
            document.getElementById('stat-failed').textContent = data.stats.failed || 0;

            const passRate = data.stats.pass_rate || '0%';
            document.getElementById('stat-passrate').textContent = passRate;
            updateProgressRing(parseInt(passRate) || 0);

            const grouped = {};
            for (const [extName, result] of Object.entries(data.results)) {
                const meta = EXTENSIONS_META[extName] || {
                    repository: 'Unknown', type: 'Unknown', description: extName, priority: 'N/A'
                };
                if (!grouped[meta.repository]) grouped[meta.repository] = {};
                if (!grouped[meta.repository][meta.type]) grouped[meta.repository][meta.type] = [];
                grouped[meta.repository][meta.type].push({ name: extName, meta, result });
            }

            const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2, 'N/A': 3 };
            for (const repo of Object.keys(grouped)) {
                for (const type of Object.keys(grouped[repo])) {
                    grouped[repo][type].sort((a, b) => {
                        const pa = priorityOrder[a.meta.priority] ?? 4;
                        const pb = priorityOrder[b.meta.priority] ?? 4;
                        return pa - pb || a.name.localeCompare(b.name);
                    });
                }
            }

            let html = '';
            for (const repo of Object.keys(grouped).sort()) {
                const repoData = grouped[repo];
                const totalCount = Object.values(repoData).reduce((sum, arr) => sum + arr.length, 0);

                html += `<div class="repository" data-repo="${repo}">
                    <div class="repo-header">
                        <span class="repo-name">${repo}</span>
                        <span class="repo-count">${totalCount} extension${totalCount === 1 ? '' : 's'}</span>
                    </div>`;

                for (const type of Object.keys(repoData).sort()) {
                    const extensions = repoData[type];
                    const iconPath = TYPE_ICONS[type] || TYPE_ICONS['Other Provider'];

                    html += `<div class="type-group">
                        <div class="type-header">
                            <span class="type-icon">
                                <svg class="icon" viewBox="0 0 24 24" style="width: 11px; height: 11px;"><path d="${iconPath}"/></svg>
                            </span>
                            <span>${type}</span>
                        </div>
                        <div class="extensions-grid">`;

                    for (const ext of extensions) {
                        html += renderExtensionCard(ext);
                    }

                    html += `</div></div>`;
                }
                html += '</div>';
            }

            document.getElementById('content').innerHTML = html;
            filterExtensions();
            updateReviewPanel();
        }

        // Status Management
        const STORAGE_KEY = 'evoq_test_status';

        function generateTestId(extName, testName) {
            return `${extName}::${testName}`.replace(/[^a-zA-Z0-9:]/g, '_');
        }

        function generateScenarioId(extName, featureName, scenarioName) {
            return `${extName}::${featureName}::${scenarioName}`.replace(/[^a-zA-Z0-9:]/g, '_');
        }

        function getAllStatus() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            } catch {
                return {};
            }
        }

        function saveAllStatus(status) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(status));
        }

        function getTestStatus(testId) {
            return getAllStatus()[testId]?.status || null;
        }

        function toggleScenarioDiscard(scenarioId, extName, featureName, scenarioName) {
            const allStatus = getAllStatus();

            if (allStatus[scenarioId]?.status === 'discarded') {
                delete allStatus[scenarioId];
            } else {
                allStatus[scenarioId] = { status: 'discarded', extName, featureName, scenarioName, timestamp: Date.now() };
            }

            saveAllStatus(allStatus);
            updateScenarioUI(scenarioId);
            updateFeatureBadge(extName, featureName);
            updateExtensionBadge(extName);
            updateReviewPanel();
        }

        function updateFeatureBadge(extName, featureName) {
            if (!currentData?.results?.[extName]?.features?.[featureName]) return;
            
            const featureData = currentData.results[extName].features[featureName];
            const scenarios = featureData.scenarios || [];
            
            let activePassed = 0;
            let activeFailed = 0;
            scenarios.forEach(s => {
                const scenarioId = generateScenarioId(extName, featureName, s.name);
                if (getTestStatus(scenarioId) !== 'discarded') {
                    if (s.status === 'PASS') activePassed++;
                    else activeFailed++;
                }
            });
            
            const featureTotal = activePassed + activeFailed;
            const featurePassRate = featureTotal > 0 ? (activePassed / featureTotal) * 100 : 0;
            const featureBadgeClass = featurePassRate >= 90 ? 'badge-pass' : featurePassRate >= 70 ? 'badge-warning' : 'badge-fail';
            
            // Find and update the feature's badge
            const testId = `${extName}::${featureName}`;
            const testItem = document.querySelector(`[data-test-id="${testId}"]`);
            if (testItem) {
                const badge = testItem.querySelector('.test-actions .badge');
                if (badge) {
                    badge.className = `badge ${featureBadgeClass}`;
                    badge.textContent = `${activePassed}/${featureTotal}`;
                }
            }
        }

        function updateExtensionBadge(extName) {
            if (!currentData?.results?.[extName]?.features) return;
            
            const features = currentData.results[extName].features;
            let extPassed = 0;
            let extFailed = 0;
            
            for (const [featureName, featureData] of Object.entries(features)) {
                const scenarios = featureData.scenarios || [];
                for (const s of scenarios) {
                    const scenarioId = generateScenarioId(extName, featureName, s.name);
                    if (getTestStatus(scenarioId) !== 'discarded') {
                        if (s.status === 'PASS') extPassed++;
                        else extFailed++;
                    }
                }
            }
            
            const extTotal = extPassed + extFailed;
            const extPassRate = extTotal > 0 ? (extPassed / extTotal) * 100 : 0;
            const extBadgeClass = extPassRate >= 90 ? 'badge-pass' : extPassRate >= 70 ? 'badge-warning' : 'badge-fail';
            
            // Find and update the extension's badge in the header
            const extCard = document.querySelector(`[data-ext-name="${extName}"]`);
            if (extCard) {
                const badge = extCard.querySelector('.extension-header .badge');
                if (badge) {
                    badge.className = `badge ${extBadgeClass}`;
                    badge.textContent = `${extPassed}/${extTotal}`;
                }
            }
        }

        function updateScenarioUI(scenarioId) {
            const scenarioItem = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (!scenarioItem) return;

            const isDiscarded = getTestStatus(scenarioId) === 'discarded';
            const btn = scenarioItem.querySelector('.scenario-discard-btn');

            scenarioItem.classList.toggle('discarded', isDiscarded);

            if (btn) {
                btn.classList.toggle('active', isDiscarded);
                btn.innerHTML = isDiscarded ? '&#x21A9;' : '&#x2715;';
            }
        }

        function updateReviewPanel() {
            const allStatus = getAllStatus();

            let totalPassed = 0;
            let totalFailed = 0;
            let discardedCount = 0;

            if (currentData?.results) {
                for (const [extName, result] of Object.entries(currentData.results)) {
                    for (const [featureName, featureData] of Object.entries(result.features || {})) {
                        const scenarios = featureData.scenarios || [];
                        for (const scenario of scenarios) {
                            const scenarioId = generateScenarioId(extName, featureName, scenario.name);
                            if (allStatus[scenarioId]?.status === 'discarded') {
                                discardedCount++;
                            } else {
                                if (scenario.status === 'PASS') totalPassed++;
                                else totalFailed++;
                            }
                        }
                    }
                }
            }

            document.getElementById('review-passed').textContent = totalPassed;
            document.getElementById('review-failed').textContent = totalFailed;
            document.getElementById('review-discarded').textContent = discardedCount;

            // Update main stats
            document.getElementById('stat-passed').textContent = totalPassed;
            document.getElementById('stat-failed').textContent = totalFailed;
            const passRate = totalPassed + totalFailed > 0
                ? Math.round(totalPassed / (totalPassed + totalFailed) * 100)
                : 0;
            document.getElementById('stat-passrate').textContent = passRate + '%';
            updateProgressRing(passRate);

            // Update discarded badge count
            const badge = document.getElementById('discardedBadge');
            if (discardedCount > 0) {
                badge.textContent = discardedCount;
                badge.classList.remove('empty');
            } else {
                badge.classList.add('empty');
            }

            // Update drawer list
            const items = Object.entries(allStatus)
                .filter(([_, v]) => v.status === 'discarded')
                .sort((a, b) => b[1].timestamp - a[1].timestamp);

            const container = document.getElementById('drawer-content');

            if (items.length === 0) {
                container.innerHTML = `<div class="drawer-empty">No discarded scenarios</div>`;
                return;
            }

            container.innerHTML = items.map(([id, data]) => `
                <div class="drawer-list-item" onclick="scrollToScenario('${id}')">
                    <span class="drawer-list-item-name">${data.scenarioName || data.featureName}</span>
                    <span class="drawer-list-item-ext">${data.extName}</span>
                </div>
            `).join('');
        }

        function scrollToScenario(scenarioId) {
            toggleDrawer();

            const scenarioItem = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (!scenarioItem) return;

            const card = scenarioItem.closest('.extension-card');
            if (card && !card.classList.contains('expanded')) {
                card.classList.add('expanded');
            }

            setTimeout(() => {
                scenarioItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                scenarioItem.style.boxShadow = '0 0 0 2px var(--accent-primary)';
                setTimeout(() => { scenarioItem.style.boxShadow = ''; }, 2000);
            }, 300);
        }

        function clearAllStatus() {
            if (confirm('Clear all review status? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                loadData();
            }
        }

        function exportReviewStatus() {
            const allStatus = getAllStatus();
            const exportData = {
                exportDate: new Date().toISOString(),
                outputFolder: outputFolder,
                _rawStatus: allStatus
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `evoq-review-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveDiscardStatus() {
            const allStatus = getAllStatus();
            
            // Generate discard_status.js content
            const jsContent = `// Discard status - saved ${new Date().toISOString()}
// Replace the existing discard_status.js file with this one to persist your changes
window.DISCARD_STATUS = ${JSON.stringify(allStatus, null, 2)};
`;
            
            const blob = new Blob([jsContent], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'discard_status.js';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Downloaded discard_status.js\\n\\nReplace the existing file in your project folder to save your discard choices.');
        }

        function importReviewStatus() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const current = getAllStatus();
                        const importData = data._rawStatus || data;
                        saveAllStatus({ ...current, ...importData });
                        loadData();
                    } catch (err) {
                        alert('Failed to import: Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        function renderExtensionCard(ext) {
            const { name, meta, result } = ext;
            const priorityClass = ['high', 'medium', 'low'].includes(meta.priority.toLowerCase()) ? meta.priority.toLowerCase() : 'na';

            let featuresHtml = '';
            let testIds = [];

            const features = result.features || {};

            for (const [featureName, featureData] of Object.entries(features)) {
                const testId = generateTestId(name, featureName);
                testIds.push(testId);

                const screenshots = featureData.screenshots || [];
                const screenshotsHtml = screenshots.slice(0, 5).map((img, idx) => `
                    <div class="screenshot-thumb" onclick="openLightbox('${result.folder}', ${JSON.stringify(screenshots)}, ${idx})">
                        <img src="${outputFolder}/${result.folder}/${img}" alt="${img}" loading="lazy">
                    </div>
                `).join('');

                const moreCount = screenshots.length - 5;
                const moreHtml = moreCount > 0 ? `<div class="more-badge">+${moreCount}</div>` : '';

                const detailBtn = featureData.json_file
                    ? `<button class="btn-sm" onclick="event.stopPropagation(); openJsonDetail('${name.replace(/'/g, "\\'")}', '${featureName.replace(/'/g, "\\'")}')">Details</button>`
                    : '';

                const scenarios = featureData.scenarios || [];

                let activePassed = 0;
                let activeFailed = 0;
                scenarios.forEach(s => {
                    const scenarioId = generateScenarioId(name, featureName, s.name);
                    if (getTestStatus(scenarioId) !== 'discarded') {
                        if (s.status === 'PASS') activePassed++;
                        else activeFailed++;
                    }
                });

                let scenariosHtml = '';
                if (scenarios.length > 0) {
                    scenariosHtml = `<div class="scenarios-list">
                        ${scenarios.map((s) => {
                            const scenarioId = generateScenarioId(name, featureName, s.name);
                            const isDiscarded = getTestStatus(scenarioId) === 'discarded';
                            const statusClass = s.status === 'PASS' ? 'pass' : 'fail';
                            const statusIcon = s.status === 'PASS' ? '&#x2713;' : '&#x2715;';
                            const discardIcon = isDiscarded ? '&#x21A9;' : '&#x2715;';
                            const issuesHtml = s.issues && s.issues.length > 0
                                ? `<div class="scenario-issues">${s.issues.map(i => `<span class="issue-tag">${i}</span>`).join('')}</div>`
                                : '';
                            return `<div class="scenario-item ${statusClass} ${isDiscarded ? 'discarded' : ''}" data-scenario-id="${scenarioId}">
                                <span class="scenario-status">${statusIcon}</span>
                                <span class="scenario-name">${s.name}</span>
                                <span class="scenario-steps">${s.step_count} steps</span>
                                <button class="scenario-discard-btn ${isDiscarded ? 'active' : ''}" onclick="event.stopPropagation(); toggleScenarioDiscard('${scenarioId}', '${name.replace(/'/g, "\\'")}', '${featureName.replace(/'/g, "\\'")}', '${s.name.replace(/'/g, "\\'")}');">${discardIcon}</button>
                            </div>${issuesHtml}`;
                        }).join('')}
                    </div>`;
                }

                const featureTotal = activePassed + activeFailed;
                const featurePassRate = featureTotal > 0 ? (activePassed / featureTotal) * 100 : 0;
                const featureBadgeClass = featurePassRate >= 90 ? 'badge-pass' : featurePassRate >= 70 ? 'badge-warning' : 'badge-fail';
                const featureSummary = `<span class="badge ${featureBadgeClass}">${activePassed}/${featureTotal}</span>`;

                featuresHtml += `<div class="test-item" data-test-id="${testId}">
                    <div class="test-header">
                        <span class="test-name">${featureName}</span>
                        <div class="test-actions">
                            ${featureSummary}
                            ${detailBtn}
                        </div>
                    </div>
                    ${scenariosHtml}
                    <div class="screenshots">${screenshotsHtml}${moreHtml}</div>
                </div>`;
            }

            let extPassed = 0;
            let extFailed = 0;
            for (const [fn, fd] of Object.entries(features)) {
                const scenarios = fd.scenarios || [];
                for (const s of scenarios) {
                    const scenarioId = generateScenarioId(name, fn, s.name);
                    if (getTestStatus(scenarioId) !== 'discarded') {
                        if (s.status === 'PASS') extPassed++;
                        else extFailed++;
                    }
                }
            }
            const extTotal = extPassed + extFailed;
            const extPassRate = extTotal > 0 ? (extPassed / extTotal) * 100 : 0;
            const extBadgeClass = extPassRate >= 90 ? 'badge-pass' : extPassRate >= 70 ? 'badge-warning' : 'badge-fail';
            const passFailBadge = extTotal > 0
                ? `<span class="badge ${extBadgeClass}">${extPassed}/${extTotal}</span>`
                : '';

            return `<div class="extension-card" data-name="${name.toLowerCase()}" data-priority="${meta.priority}" data-ext-name="${name}">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-info">
                        <div class="extension-name">${name}</div>
                        <div class="extension-desc">${meta.description}</div>
                    </div>
                    <div class="card-meta">
                        <span class="badge badge-priority ${priorityClass}">${meta.priority}</span>
                        ${passFailBadge}
                        <span class="expand-icon">&#x25BC;</span>
                    </div>
                </div>
                <div class="card-content">${featuresHtml}</div>
            </div>`;
        }

        function toggleCard(header) {
            header.closest('.extension-card').classList.toggle('expanded');
        }

        function openLightbox(folder, images, index) {
            currentLightboxImages = images.map(img => `${outputFolder}/${folder}/${img}`);
            currentLightboxIndex = index;
            updateLightbox();
            document.getElementById('lightbox').classList.add('active');
        }

        function updateLightbox() {
            document.getElementById('lightbox-img').src = currentLightboxImages[currentLightboxIndex];
            document.getElementById('lightbox-caption').textContent =
                `${currentLightboxIndex + 1} / ${currentLightboxImages.length}  ${currentLightboxImages[currentLightboxIndex].split('/').pop()}`;
        }

        function navigateLightbox(delta) {
            currentLightboxIndex = (currentLightboxIndex + delta + currentLightboxImages.length) % currentLightboxImages.length;
            updateLightbox();
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        // JSON Detail Modal
        let currentJsonUrl = '';
        let currentJsonData = null;
        let currentDetailFolder = '';
        let currentDetailExtName = '';
        let currentDetailFeatureName = '';

        function openJsonDetail(extName, featureName) {
            document.getElementById('reportModalTitle').textContent = featureName + ' - Test Results';

            const extData = currentData?.results?.[extName];
            const featureData = extData?.features?.[featureName];

            if (featureData?.full_data) {
                currentJsonData = featureData.full_data;
                currentJsonUrl = `${outputFolder}/${extData.folder}/${featureData.json_file}`;
                currentDetailFolder = `${outputFolder}/${extData.folder}`;
                currentDetailExtName = extName;
                currentDetailFeatureName = featureName;
                renderJsonDetail(currentJsonData, currentDetailFolder);
                document.getElementById('reportModal').classList.add('active');
            } else {
                document.getElementById('reportModalContent').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--status-error);">
                        Test data not available. Re-run update_manifest.py to embed data.
                    </div>
                `;
                document.getElementById('reportModal').classList.add('active');
            }
        }

        function renderJsonDetail(data, folderPath) {
            const meta = data.metadata || {};
            const scenarios = data.test_scenarios || [];
            const observations = data.observations || [];

            currentDetailExtName = meta.extension_name || '';
            currentDetailFeatureName = meta.feature_name || '';
            currentDetailFolder = folderPath;

            const allScreenshots = [];
            scenarios.forEach(s => {
                (s.steps || []).forEach(step => {
                    if (step.screenshot) allScreenshots.push(step.screenshot);
                });
            });

            let activePassed = 0;
            let activeFailed = 0;
            scenarios.forEach(s => {
                const scenarioId = generateScenarioId(currentDetailExtName, currentDetailFeatureName, s.scenario_name);
                if (getTestStatus(scenarioId) !== 'discarded') {
                    if (s.status === 'PASS') activePassed++;
                    else activeFailed++;
                }
            });
            const activeTotal = activePassed + activeFailed;
            const activePassRateNum = activeTotal > 0 ? Math.round(activePassed / activeTotal * 100) : 0;
            const activePassRate = `${activePassRateNum}%`;
            const passRateColorClass = activePassRateNum >= 90 ? 'rate-success' : activePassRateNum >= 70 ? 'rate-warning' : 'rate-error';

            let html = `
                <div class="json-detail">
                    <div class="json-meta">
                        <h2>${meta.feature_name || 'Unknown Feature'}</h2>
                        <p>${meta.feature_description || ''}</p>
                        <div class="json-meta-row">
                            <span>Extension: <strong>${meta.extension_name}</strong></span>
                            <span>Priority: <strong>${meta.feature_priority}</strong></span>
                            <span>Test Date: <strong>${meta.test_date ? new Date(meta.test_date).toLocaleString() : 'N/A'}</strong></span>
                        </div>
                    </div>

                    <div class="json-summary">
                        <div class="summary-stat pass"><span class="num">${activePassed}</span><span class="label">Passed</span></div>
                        <div class="summary-stat fail"><span class="num">${activeFailed}</span><span class="label">Failed</span></div>
                        <div class="summary-stat total ${passRateColorClass}"><span class="num">${activePassRate}</span><span class="label">Pass Rate</span></div>
                    </div>

                    <div class="json-scenarios">
                        <h3>Test Scenarios</h3>
                        ${scenarios.map((s) => {
                            const scenarioId = generateScenarioId(currentDetailExtName, currentDetailFeatureName, s.scenario_name);
                            const isDiscarded = getTestStatus(scenarioId) === 'discarded';
                            const escapedScenarioName = s.scenario_name.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                            return `
                            <div class="json-scenario ${s.status === 'PASS' ? 'pass' : 'fail'} ${isDiscarded ? 'discarded' : ''}" data-detail-scenario-id="${scenarioId}">
                                <div class="scenario-header">
                                    <span class="status-icon">${s.status === 'PASS' ? '&#x2713;' : '&#x2715;'}</span>
                                    <span class="scenario-title">${s.scenario_name}</span>
                                    <button class="detail-discard-btn ${isDiscarded ? 'active' : ''}" onclick="toggleDetailScenarioDiscard('${scenarioId}', '${escapedScenarioName}')">${isDiscarded ? 'Restore' : 'Discard'}</button>
                                    <span class="status-badge ${s.status.toLowerCase()}">${s.status}</span>
                                </div>
                                <div class="scenario-steps-detail">
                                    ${(s.steps || []).map(step => {
                                        const screenshotIdx = step.screenshot ? allScreenshots.indexOf(step.screenshot) : -1;
                                        const screenshotJson = JSON.stringify(allScreenshots).replace(/"/g, '&quot;');
                                        const screenshotHtml = step.screenshot ? `
                                            <div class="step-screenshot-container">
                                                <img src="${folderPath}/${step.screenshot}"
                                                     alt="${step.screenshot}"
                                                     class="step-screenshot-img"
                                                     onclick="openDetailLightbox('${folderPath}', ${screenshotJson}, ${screenshotIdx})"
                                                     loading="lazy">
                                                <span class="step-screenshot-name">${step.screenshot}</span>
                                            </div>
                                        ` : '';
                                        return `
                                            <div class="step">
                                                <div class="step-num">${step.step_number}</div>
                                                <div class="step-content">
                                                    <div class="step-action"><strong>Action:</strong> ${step.action}</div>
                                                    <div class="step-expected"><strong>Expected:</strong> ${step.expected}</div>
                                                    <div class="step-actual"><strong>Actual:</strong> ${step.actual}</div>
                                                    ${screenshotHtml}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                ${s.issues && s.issues.length > 0 ? `
                                    <div class="scenario-issues-detail">
                                        <strong>Issues:</strong>
                                        <ul>${s.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>

                    ${observations.length > 0 ? `
                        <div class="json-observations">
                            <h3>Observations</h3>
                            <ul>${observations.map(o => `<li>${o}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('reportModalContent').innerHTML = html;
        }

        function toggleDetailScenarioDiscard(scenarioId, scenarioName) {
            const allStatus = getAllStatus();

            if (allStatus[scenarioId]?.status === 'discarded') {
                delete allStatus[scenarioId];
            } else {
                allStatus[scenarioId] = {
                    status: 'discarded',
                    extName: currentDetailExtName,
                    featureName: currentDetailFeatureName,
                    scenarioName: scenarioName,
                    timestamp: Date.now()
                };
            }

            saveAllStatus(allStatus);

            const scenarioEl = document.querySelector(`[data-detail-scenario-id="${scenarioId}"]`);
            if (scenarioEl) {
                const isDiscarded = allStatus[scenarioId]?.status === 'discarded';
                scenarioEl.classList.toggle('discarded', isDiscarded);

                const btn = scenarioEl.querySelector('.detail-discard-btn');
                if (btn) {
                    btn.classList.toggle('active', isDiscarded);
                    btn.textContent = isDiscarded ? 'Restore' : 'Discard';
                }
            }

            updateDetailSummary();
            updateScenarioUI(scenarioId);
            updateReviewPanel();
        }

        function updateDetailSummary() {
            if (!currentJsonData) return;

            const scenarios = currentJsonData.test_scenarios || [];
            let activePassed = 0;
            let activeFailed = 0;

            scenarios.forEach(s => {
                const scenarioId = generateScenarioId(currentDetailExtName, currentDetailFeatureName, s.scenario_name);
                if (getTestStatus(scenarioId) !== 'discarded') {
                    if (s.status === 'PASS') activePassed++;
                    else activeFailed++;
                }
            });

            const activeTotal = activePassed + activeFailed;
            const activePassRateNum = activeTotal > 0 ? Math.round(activePassed / activeTotal * 100) : 0;
            const activePassRate = `${activePassRateNum}%`;

            const passedEl = document.querySelector('.json-detail .summary-stat.pass .num');
            const failedEl = document.querySelector('.json-detail .summary-stat.fail .num');
            const rateStat = document.querySelector('.json-detail .summary-stat.total');
            const rateEl = rateStat ? rateStat.querySelector('.num') : null;

            if (passedEl) passedEl.textContent = activePassed;
            if (failedEl) failedEl.textContent = activeFailed;
            if (rateEl) rateEl.textContent = activePassRate;
            
            // Update color class based on pass rate
            if (rateStat) {
                rateStat.classList.remove('rate-success', 'rate-warning', 'rate-error');
                if (activePassRateNum >= 90) rateStat.classList.add('rate-success');
                else if (activePassRateNum >= 70) rateStat.classList.add('rate-warning');
                else rateStat.classList.add('rate-error');
            }
        }

        function openDetailLightbox(folder, images, index) {
            currentLightboxImages = images.map(img => `${folder}/${img}`);
            currentLightboxIndex = index;
            updateLightbox();
            document.getElementById('lightbox').classList.add('active');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            document.getElementById('reportModalContent').innerHTML = '';
            currentJsonData = null;
        }

        function openReportNewTab() {
            if (currentJsonUrl) {
                window.open(currentJsonUrl, '_blank');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('reportModal').classList.contains('active')) {
                    closeReportModal();
                } else if (document.getElementById('lightbox').classList.contains('active')) {
                    closeLightbox();
                } else if (document.getElementById('drawer').classList.contains('active')) {
                    toggleDrawer();
                }
            }
            if (document.getElementById('lightbox').classList.contains('active')) {
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
            }
        });

        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target.id === 'lightbox') closeLightbox();
        });

        document.getElementById('reportModal').addEventListener('click', (e) => {
            if (e.target.id === 'reportModal') closeReportModal();
        });

        document.getElementById('searchInput').addEventListener('input', filterExtensions);

        document.querySelectorAll('.filter-btn[data-priority]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn[data-priority]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterExtensions();
            });
        });

        function filterExtensions() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const activePriorityBtn = document.querySelector('.filter-btn[data-priority].active');
            const priority = activePriorityBtn?.dataset.priority || 'all';

            document.querySelectorAll('.extension-card').forEach(card => {
                const name = card.dataset.name;
                const cardPriority = card.dataset.priority;
                const matchesSearch = name.includes(query);
                const matchesPriority = priority === 'all' || cardPriority === priority;

                card.style.display = matchesSearch && matchesPriority ? '' : 'none';
            });

            document.querySelectorAll('.type-group').forEach(group => {
                const hasVisible = Array.from(group.querySelectorAll('.extension-card')).some(card => card.style.display !== 'none');
                group.style.display = hasVisible ? '' : 'none';
            });

            document.querySelectorAll('.repository').forEach(repo => {
                const hasVisible = Array.from(repo.querySelectorAll('.extension-card')).some(card => card.style.display !== 'none');
                repo.style.display = hasVisible ? '' : 'none';
            });
        }

        loadData();
    </script>
</body>
</html>
