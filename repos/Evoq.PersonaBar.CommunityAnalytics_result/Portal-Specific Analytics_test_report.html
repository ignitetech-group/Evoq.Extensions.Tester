<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report: Portal-Specific Analytics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0 0 10px 0;
        }
        .header p {
            margin: 5px 0;
            opacity: 0.9;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #1a237e;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .status-pass {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .status-fail {
            background: #ffcdd2;
            color: #c62828;
        }
        .screenshot {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .steps {
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .steps li {
            margin: 8px 0;
        }
        .issue {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }
        .observations {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .summary-table th, .summary-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .summary-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Portal-Specific Analytics - Test Report</h1>
        <p><strong>Extension:</strong> Evoq.PersonaBar.CommunityAnalytics</p>
        <p><strong>Feature:</strong> Portal-Specific Analytics - Isolation of analytics data per portal in multi-portal installations</p>
        <p><strong>Test Date:</strong> January 6, 2026</p>
        <p><strong>Priority:</strong> High</p>
    </div>

    <!-- Summary Table -->
    <div class="test-section">
        <h2>Test Summary</h2>
        <table class="summary-table">
            <tr>
                <th>Test Scenario</th>
                <th>Status</th>
                <th>Notes</th>
            </tr>
            <tr>
                <td>Verify portal data isolation</td>
                <td><span class="status status-fail">FAIL</span></td>
                <td>Community Analytics UI fails to load due to JavaScript error</td>
            </tr>
            <tr>
                <td>Test cross-portal data prevention</td>
                <td><span class="status status-fail">FAIL</span></td>
                <td>Cannot verify - Community Analytics panel does not render</td>
            </tr>
            <tr>
                <td>Validate portal ID handling</td>
                <td><span class="status status-pass">PASS</span></td>
                <td>Code review confirms proper implementation using EffectivePortalId</td>
            </tr>
            <tr>
                <td>Test with portal groups</td>
                <td><span class="status status-fail">FAIL</span></td>
                <td>Cannot verify via UI due to Community Analytics failure</td>
            </tr>
            <tr>
                <td>Verify host user access</td>
                <td><span class="status status-pass">PASS</span></td>
                <td>Host user can access both portals via PersonaBar site selector</td>
            </tr>
            <tr>
                <td>Test portal switching</td>
                <td><span class="status status-pass">PASS</span></td>
                <td>Portal switching works correctly in Site Settings</td>
            </tr>
        </table>
    </div>

    <!-- Test 1: Host User Access -->
    <div class="test-section">
        <h2>Test 1: Host User Access Verification</h2>
        <span class="status status-pass">PASS</span>

        <h3>What was tested</h3>
        <p>Verified that the host/superuser account can access the Community Analytics feature location and switch between portals.</p>

        <div class="steps">
            <h4>Steps taken:</h4>
            <ol>
                <li>Logged in as host user (SuperUser Account)</li>
                <li>Navigated to PersonaBar > Dashboard</li>
                <li>Verified Community Analytics menu option is visible</li>
                <li>Verified access to Site Settings and portal selector</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <img src="Portal-Specific_Analytics_step00_login_verified.png" alt="Login verified" class="screenshot">
        <p><em>Screenshot showing successful login as SuperUser Account with PersonaBar visible</em></p>
    </div>

    <!-- Test 2: Portal Switching -->
    <div class="test-section">
        <h2>Test 2: Portal Switching</h2>
        <span class="status status-pass">PASS</span>

        <h3>What was tested</h3>
        <p>Verified that the host user can switch between multiple portals using the "EDITING SITE" dropdown in Site Settings.</p>

        <div class="steps">
            <h4>Steps taken:</h4>
            <ol>
                <li>Navigated to PersonaBar > Settings > Site Settings</li>
                <li>Clicked on "EDITING SITE: MY WEBSITE" dropdown</li>
                <li>Observed two portals available: "My Website" (Portal 0) and "Test Portal" (Portal 1)</li>
                <li>Selected "Test Portal" from the dropdown</li>
                <li>Verified context changed to Portal 1 (Home Directory: Portals/1)</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <img src="Portal-Specific_Analytics_step05_portal_selector.png" alt="Portal selector showing two portals" class="screenshot">
        <p><em>Screenshot showing portal selector dropdown with two portals available</em></p>

        <img src="Portal-Specific_Analytics_step06_test_portal_selected.png" alt="Test Portal selected" class="screenshot">
        <p><em>Screenshot showing Test Portal selected (Home Directory: Portals/1, GUID: 99D361B4-4A4B-41C7-9611-0FD8CC777F32)</em></p>
    </div>

    <!-- Test 3: Community Analytics UI -->
    <div class="test-section">
        <h2>Test 3: Community Analytics Panel Loading</h2>
        <span class="status status-fail">FAIL</span>

        <h3>What was tested</h3>
        <p>Attempted to access the Community Analytics panel via PersonaBar > Dashboard > Community Analytics.</p>

        <div class="steps">
            <h4>Steps taken:</h4>
            <ol>
                <li>Clicked on Dashboard icon in PersonaBar</li>
                <li>Clicked on "Community Analytics" menu item</li>
                <li>Observed blank/empty panel area</li>
                <li>Checked browser console for errors</li>
            </ol>
        </div>

        <div class="issue">
            <h4>Issue Found</h4>
            <p><strong>JavaScript Error:</strong> The Community Analytics panel fails to render due to a JavaScript initialization error.</p>
            <div class="code">
TypeError: utility.serializeCustomDate is not a function
    at dashboardClass.init (social-dashboard-combined-instance.js:1025:39)
    at Object.init (social-dashboard-combined.js:16:23)
            </div>
            <p>This error occurs in the <code>dashboardClass.init</code> function when trying to call <code>utility.serializeCustomDate</code>, which is undefined. This prevents the Community Analytics dashboard from initializing.</p>
        </div>

        <h3>Evidence</h3>
        <img src="Portal-Specific_Analytics_step01_community_analytics.png" alt="Community Analytics menu" class="screenshot">
        <p><em>Screenshot showing Dashboard menu with Community Analytics option highlighted</em></p>

        <img src="Portal-Specific_Analytics_step03_community_analytics_panel.png" alt="Blank Community Analytics panel" class="screenshot">
        <p><em>Screenshot showing blank panel area where Community Analytics should render</em></p>
    </div>

    <!-- Test 4: Site Analytics (Comparison) -->
    <div class="test-section">
        <h2>Test 4: Site Analytics (Control Test)</h2>
        <span class="status status-pass">PASS</span>

        <h3>What was tested</h3>
        <p>Tested Site Analytics as a comparison to verify the PersonaBar Dashboard area is working properly.</p>

        <div class="steps">
            <h4>Steps taken:</h4>
            <ol>
                <li>Navigated to PersonaBar > Dashboard > Site Analytics</li>
                <li>Observed Site Analytics panel loading successfully</li>
                <li>Verified dashboard shows date range, tabs (Summary, Traffic), and sections (Insights, Top Fives)</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <img src="Portal-Specific_Analytics_step04_site_analytics_works.png" alt="Site Analytics working" class="screenshot">
        <p><em>Screenshot showing Site Analytics panel loading correctly with Insights and Top Fives sections visible</em></p>

        <p><strong>Result:</strong> Site Analytics works correctly, confirming the issue is specific to Community Analytics, not the PersonaBar Dashboard infrastructure.</p>
    </div>

    <!-- Test 5: Portal ID Handling (Code Review) -->
    <div class="test-section">
        <h2>Test 5: Portal ID Handling (Code Review)</h2>
        <span class="status status-pass">PASS</span>

        <h3>What was tested</h3>
        <p>Reviewed the source code to verify portal-specific data isolation is properly implemented.</p>

        <h3>Code Analysis</h3>
        <p><strong>File:</strong> Services/CommunityAnalyticsController.cs (lines 33-45)</p>
        <div class="code">
private int _effectivePortalId = Null.NullInteger;
protected int EffectivePortalId
{
    get
    {
        if (_effectivePortalId == Null.NullInteger)
        {
            _effectivePortalId = ActiveModule != null
                ? ActiveModule.OwnerPortalID
                : PortalController.GetEffectivePortalId(PortalSettings.PortalId);
        }
        return _effectivePortalId;
    }
}
        </div>

        <p><strong>Key Findings:</strong></p>
        <ul>
            <li>The <code>EffectivePortalId</code> property correctly determines the portal context</li>
            <li>All API methods (GetDashboardInfo, GetTagStats, GetPopularContent, etc.) pass <code>EffectivePortalId</code> as the first parameter</li>
            <li>This ensures data is always filtered by the current portal context</li>
            <li>Portal groups are handled via <code>PortalController.GetEffectivePortalId()</code></li>
        </ul>

        <p><strong>API Methods using EffectivePortalId:</strong></p>
        <ul>
            <li><code>GetDashboardInfo(EffectivePortalId, period, comparativeTerm, startDate, endDate)</code></li>
            <li><code>GetTagStats(EffectivePortalId, period, pageIndex, pageSize, ...)</code></li>
            <li><code>GetPopularContent(EffectivePortalId, null, period, ...)</code></li>
            <li><code>GetModuleDashboardInfo(EffectivePortalId, moduleName, ...)</code></li>
            <li><code>GetModuleContextData(EffectivePortalId, moduleName, ...)</code></li>
            <li><code>GetModuleTagStats(EffectivePortalId, moduleName, ...)</code></li>
            <li><code>GetModulePopularContent(EffectivePortalId, moduleName, ...)</code></li>
        </ul>

        <p><strong>Result:</strong> Code review confirms portal-specific data isolation is properly implemented at the API level.</p>
    </div>

    <!-- Observations Section -->
    <div class="test-section">
        <h2>Observations</h2>

        <div class="observations">
            <h4>1. Community Analytics JavaScript Bug</h4>
            <p>The Community Analytics feature has a critical JavaScript bug that prevents the UI from loading. The error <code>utility.serializeCustomDate is not a function</code> suggests a missing or improperly loaded utility function. This blocks all UI testing of portal-specific analytics features.</p>
        </div>

        <div class="observations">
            <h4>2. API Server Error</h4>
            <p>Direct API calls to <code>/en-us/API/personaBar/CommunityAnalytics/GetDashboardInfo</code> return HTTP 500 errors. This may be related to the Analytics Warehouse dependency or data initialization issues.</p>
        </div>

        <div class="observations">
            <h4>3. Code Architecture is Sound</h4>
            <p>Despite the UI failures, the code architecture properly implements portal-specific data isolation. All analytics API methods correctly use <code>EffectivePortalId</code> to filter data by portal context. Once the JavaScript issue is resolved, portal isolation should work as designed.</p>
        </div>

        <div class="observations">
            <h4>4. Multi-Portal Environment Confirmed</h4>
            <p>The test environment has two portals configured:</p>
            <ul>
                <li><strong>My Website</strong> - Portal 0 (Home Directory: Portals/0)</li>
                <li><strong>Test Portal</strong> - Portal 1 (Home Directory: Portals/1, Description: "Test Portal for Multi-Portal Configuration Testing")</li>
            </ul>
        </div>

        <div class="observations">
            <h4>5. Site Analytics Works Correctly</h4>
            <p>Site Analytics (a sibling feature to Community Analytics) loads and displays correctly, confirming the PersonaBar infrastructure is functional. The issue is isolated to Community Analytics.</p>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="test-section">
        <h2>Recommendations</h2>
        <ol>
            <li><strong>Fix JavaScript Bug:</strong> Investigate and fix the missing <code>utility.serializeCustomDate</code> function in the Community Analytics scripts. Check if a utility module is failing to load or if there's a dependency issue.</li>
            <li><strong>Verify Script Loading Order:</strong> Ensure all required JavaScript modules are loaded before <code>social-dashboard-combined-instance.js</code> initializes.</li>
            <li><strong>Test API Endpoint:</strong> Debug the 500 error on the Community Analytics API to ensure the backend services are properly configured.</li>
            <li><strong>Re-test After Fix:</strong> Once the JavaScript issue is resolved, re-run portal-specific analytics tests to verify:
                <ul>
                    <li>Data isolation between Portal 0 and Portal 1</li>
                    <li>Proper portal context switching in analytics data</li>
                    <li>Cross-portal data prevention</li>
                </ul>
            </li>
        </ol>
    </div>

    <footer style="text-align: center; padding: 20px; color: #666; font-size: 14px;">
        <p>Test Report Generated: January 6, 2026 | Evoq.PersonaBar.CommunityAnalytics v1.0</p>
    </footer>
</body>
</html>
