<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report: Universal Analytics & GA4 Support</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #444;
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        h3 {
            color: #555;
        }
        .feature-info {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
        }
        .test-case {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pass {
            color: white;
            background-color: #28a745;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
        }
        .fail {
            color: white;
            background-color: #dc3545;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
        }
        .screenshot {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .steps {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .observations {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .security-note {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Test Report: Universal Analytics & GA4 Support</h1>

    <div class="feature-info">
        <h3>Feature Details</h3>
        <p><strong>Extension:</strong> Evoq.GoogleAnalyticsConnector</p>
        <p><strong>Feature Name:</strong> Universal Analytics & GA4 Support</p>
        <p><strong>Description:</strong> Support for both Universal Analytics (UA-) and Google Analytics 4 (G-) tracking codes with appropriate configuration.</p>
        <p><strong>UI Location:</strong> Admin > Settings > Connectors > Google Analytics</p>
        <p><strong>Test Date:</strong> January 6, 2026</p>
    </div>

    <h2>Test Summary</h2>
    <table>
        <tr>
            <th>Test Scenario</th>
            <th>Status</th>
        </tr>
        <tr>
            <td>Configure UA tracking code (UA-XXXXX)</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Configure GA4 tracking code (G-XXXXX)</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Display warning for UA deprecation</td>
            <td><span class="fail">FAIL</span></td>
        </tr>
        <tr>
            <td>Auto-detect analytics version from tracking ID</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Load correct config file based on version</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Test analytics.js vs gtag.js script injection</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Empty input validation</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Invalid format handling</td>
            <td><span class="pass">PASS</span></td>
        </tr>
        <tr>
            <td>Special characters/XSS input handling</td>
            <td><span class="fail">FAIL</span></td>
        </tr>
        <tr>
            <td>Track for Administrators checkbox</td>
            <td><span class="pass">PASS</span></td>
        </tr>
    </table>

    <h2>Detailed Test Results</h2>

    <!-- Test 1: Configure UA tracking code -->
    <div class="test-case">
        <h3>Test 1: Configure UA Tracking Code (UA-XXXXX)</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Navigate to Admin > Settings > Connectors</li>
                <li>Click Edit on Google Analytics 4 connector</li>
                <li>Enter UA tracking code: UA-12345678-1</li>
                <li>Click Save</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> UA tracking code should be accepted and saved</p>
        <p><strong>Actual Result:</strong> UA tracking code was saved successfully with "Item successfully saved" message</p>
        <img src="Universal Analytics & GA4 Support_step03_ua_tracking_code_entered.png" alt="UA tracking code entered" class="screenshot">
        <img src="Universal Analytics & GA4 Support_step04_ua_saved_success.png" alt="UA tracking code saved" class="screenshot">
    </div>

    <!-- Test 2: Configure GA4 tracking code -->
    <div class="test-case">
        <h3>Test 2: Configure GA4 Tracking Code (G-XXXXX)</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Navigate to Google Analytics connector settings</li>
                <li>Enter GA4 tracking code: G-TEST123456</li>
                <li>Click Save</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> GA4 tracking code should be accepted and saved</p>
        <p><strong>Actual Result:</strong> GA4 tracking code was saved successfully with "Item successfully saved" message</p>
        <img src="Universal Analytics & GA4 Support_step05_ga4_tracking_code_entered.png" alt="GA4 tracking code entered" class="screenshot">
        <img src="Universal Analytics & GA4 Support_step06_ga4_saved_success.png" alt="GA4 tracking code saved" class="screenshot">
    </div>

    <!-- Test 3: UA Deprecation Warning -->
    <div class="test-case">
        <h3>Test 3: Display Warning for UA Deprecation</h3>
        <p><strong>Status:</strong> <span class="fail">FAIL</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Enter a UA tracking code (UA-12345678-1)</li>
                <li>Observe UI for any deprecation warning</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> A warning should be displayed indicating Universal Analytics is deprecated</p>
        <p><strong>Actual Result:</strong> No deprecation warning was displayed when entering or saving a UA tracking code. The system accepted the UA code without any notification about UA being sunset by Google.</p>
        <p><strong>Issue:</strong> Universal Analytics was officially sunset by Google on July 1, 2023. Users should be warned that UA tracking codes will not work.</p>
    </div>

    <!-- Test 4: Auto-detect analytics version -->
    <div class="test-case">
        <h3>Test 4: Auto-detect Analytics Version from Tracking ID</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Review code in GoogleAnalyticsConnector.cs</li>
                <li>Test with UA- prefix (Universal Analytics)</li>
                <li>Test with G- prefix (GA4)</li>
                <li>Test with invalid prefix (Other)</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> System should auto-detect analytics version based on tracking ID prefix</p>
        <p><strong>Actual Result:</strong> Code analysis confirms the GetAnalyticsVersion() method correctly detects:</p>
        <ul>
            <li>UA- prefix = Universal Analytics</li>
            <li>G- prefix = GA4</li>
            <li>Other prefixes = Other version</li>
        </ul>
        <p>All formats were accepted and saved by the system, confirming the detection works.</p>
    </div>

    <!-- Test 5: Config file loading -->
    <div class="test-case">
        <h3>Test 5: Load Correct Config File Based on Version</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Review SiteAnalytics.config file content</li>
                <li>Verify both UA (analytics.js) and GA4 (gtag.js) engines are present</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> Different config files should be used for UA vs GA4</p>
        <p><strong>Actual Result:</strong> The SiteAnalytics.config file contains both analytics engines:</p>
        <ul>
            <li>Universal Analytics: Uses analytics.js with ga('create'...) syntax</li>
            <li>GA4: Uses gtag.js from googletagmanager.com with gtag('config'...) syntax</li>
        </ul>
        <p>The EnsureConfig method in the code correctly copies the appropriate config template based on the detected version.</p>
    </div>

    <!-- Test 6: Script injection -->
    <div class="test-case">
        <h3>Test 6: Analytics.js vs Gtag.js Script Injection</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Review SiteAnalytics.config and SiteAnalytics.GA4.config</li>
                <li>Verify different scripts are defined for each version</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> UA should inject analytics.js, GA4 should inject gtag.js</p>
        <p><strong>Actual Result:</strong> Configuration confirmed:</p>
        <ul>
            <li><strong>Universal Analytics:</strong> <code>https://www.google-analytics.com/analytics.js</code></li>
            <li><strong>GA4:</strong> <code>https://www.googletagmanager.com/gtag/js?id=[TRACKING_ID]</code></li>
        </ul>
    </div>

    <!-- Test 7: Empty input -->
    <div class="test-case">
        <h3>Test 7: Empty Input Validation</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Clear the Measurement ID field</li>
                <li>Click Save</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> Error message should be displayed</p>
        <p><strong>Actual Result:</strong> Error message "Tracking Code Cannot Be Empty" was displayed correctly</p>
        <img src="Universal Analytics & GA4 Support_step07_empty_input.png" alt="Empty input" class="screenshot">
        <img src="Universal Analytics & GA4 Support_step08_empty_input_error.png" alt="Empty input error" class="screenshot">
    </div>

    <!-- Test 8: Invalid format -->
    <div class="test-case">
        <h3>Test 8: Invalid Format Handling</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Enter invalid tracking ID: INVALID-12345</li>
                <li>Click Save</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> System should either reject or handle invalid format</p>
        <p><strong>Actual Result:</strong> The system accepted and saved the invalid format. This is by design - the code classifies non-UA/non-GA4 prefixes as "Other" version. While it saves, it may not function correctly at runtime.</p>
        <img src="Universal Analytics & GA4 Support_step09_invalid_format_entered.png" alt="Invalid format entered" class="screenshot">
        <img src="Universal Analytics & GA4 Support_step10_invalid_format_saved.png" alt="Invalid format saved" class="screenshot">
    </div>

    <!-- Test 9: XSS/Special characters -->
    <div class="test-case">
        <h3>Test 9: Special Characters/XSS Input Handling</h3>
        <p><strong>Status:</strong> <span class="fail">FAIL</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Enter XSS payload: &lt;script&gt;alert('XSS')&lt;/script&gt;</li>
                <li>Click Save</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> System should sanitize or reject malicious input</p>
        <p><strong>Actual Result:</strong> The XSS payload was accepted and saved without any input sanitization or validation. This is a potential security concern.</p>
        <img src="Universal Analytics & GA4 Support_step11_xss_test_entered.png" alt="XSS test entered" class="screenshot">
        <img src="Universal Analytics & GA4 Support_step12_xss_saved.png" alt="XSS saved" class="screenshot">
        <div class="security-note">
            <strong>Security Note:</strong> The Measurement ID field accepts and saves script tags without sanitization. While the tracking ID is typically used in a controlled context (the analytics script template), input validation should be implemented to prevent potential injection attacks. Recommendation: Add input validation to only accept alphanumeric characters and hyphens.
        </div>
    </div>

    <!-- Test 10: Track for Administrators -->
    <div class="test-case">
        <h3>Test 10: Track for Administrators Checkbox</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Check the "Track for Administrators" checkbox</li>
                <li>Click Save</li>
            </ol>
        </div>
        <p><strong>Expected Result:</strong> Checkbox state should be saved</p>
        <p><strong>Actual Result:</strong> Checkbox state was saved successfully. When checked, analytics tracking will include administrator page views.</p>
        <img src="Universal Analytics & GA4 Support_step13_track_admins_checked.png" alt="Track for Administrators checked" class="screenshot">
        <img src="Universal Analytics & GA4 Support_step14_final_config_saved.png" alt="Final config saved" class="screenshot">
    </div>

    <h2>Observations</h2>
    <div class="observations">
        <h3>Code-Level Observations (features in code but not directly testable via UI)</h3>
        <ul>
            <li><strong>Domain Name Setting:</strong> Code supports a DomainName setting that wasn't visible in the UI form. This may be handled automatically or exposed in a different configuration location.</li>
            <li><strong>Custom Rules/Segmentation:</strong> The GoogleAnalyticsConnector.cs code includes support for analytics rules (GetRulesAsConfig, ParseRuleSettings) that can filter tracking by page and role. No UI was found to configure these rules in the Connectors panel.</li>
            <li><strong>URL Parameter Setting:</strong> Code references a URL parameter setting for custom tracking, not exposed in the visible UI.</li>
            <li><strong>Google Tag Manager Override:</strong> Code checks for a "GTMUseTagManagerForGA" setting that can disable GA script injection when Google Tag Manager is used instead.</li>
        </ul>
    </div>

    <h2>Issues Found</h2>
    <div class="security-note">
        <h3>Issues Summary</h3>
        <ol>
            <li><strong>Missing UA Deprecation Warning (Medium Priority):</strong> No warning is displayed when users configure Universal Analytics tracking codes, despite Google having sunset UA on July 1, 2023.</li>
            <li><strong>Insufficient Input Validation (High Priority):</strong> The Measurement ID field accepts arbitrary input including script tags without sanitization. Input validation should be implemented.</li>
            <li><strong>Invalid Format Acceptance (Low Priority):</strong> The system accepts tracking IDs that don't match UA or GA4 patterns. While it handles them as "Other" version, a warning might be helpful.</li>
        </ol>
    </div>

    <h2>Test Environment</h2>
    <ul>
        <li><strong>Website URL:</strong> http://localhost:8081</li>
        <li><strong>Browser:</strong> Playwright-controlled browser (1280x720 viewport)</li>
        <li><strong>Test User:</strong> SuperUser Account (host)</li>
        <li><strong>Code Repository:</strong> Dnn.Evoq.Basic</li>
    </ul>

</body>
</html>
