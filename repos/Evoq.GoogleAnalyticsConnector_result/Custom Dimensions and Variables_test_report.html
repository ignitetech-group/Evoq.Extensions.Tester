<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report: Custom Dimensions and Variables - Evoq.GoogleAnalyticsConnector</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0 0 10px 0;
        }
        .header .meta {
            opacity: 0.9;
            font-size: 14px;
        }
        .section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #1a73e8;
            border-bottom: 2px solid #e8f0fe;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .section h3 {
            color: #5f6368;
            margin-top: 20px;
        }
        .test-scenario {
            border-left: 4px solid #1a73e8;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .test-scenario.pass {
            border-left-color: #34a853;
        }
        .test-scenario.fail {
            border-left-color: #ea4335;
        }
        .test-scenario.blocked {
            border-left-color: #fbbc04;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }
        .status.pass {
            background: #e6f4ea;
            color: #1e8e3e;
        }
        .status.fail {
            background: #fce8e6;
            color: #d93025;
        }
        .status.blocked {
            background: #fef7e0;
            color: #f9ab00;
        }
        .screenshot {
            margin: 15px 0;
            text-align: center;
        }
        .screenshot img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .screenshot .caption {
            font-size: 13px;
            color: #5f6368;
            margin-top: 8px;
        }
        .code-block {
            background: #263238;
            color: #aabbc3;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        .code-block .keyword {
            color: #89ddff;
        }
        .code-block .string {
            color: #c3e88d;
        }
        .code-block .number {
            color: #f78c6c;
        }
        .findings {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .findings h4 {
            color: #e65100;
            margin-top: 0;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .summary-table {
            margin-top: 20px;
        }
        .summary-table td:first-child {
            font-weight: 600;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Test Report: Custom Dimensions and Variables</h1>
        <div class="meta">
            <strong>Extension:</strong> Evoq.GoogleAnalyticsConnector |
            <strong>Feature Priority:</strong> Medium |
            <strong>Test Date:</strong> December 30, 2025
        </div>
    </div>

    <div class="section">
        <h2>Feature Overview</h2>
        <p><strong>Feature Name:</strong> Custom Dimensions and Variables</p>
        <p><strong>Description:</strong> Configure custom tracking dimensions and variables based on segmentation rules for enhanced analytics.</p>
        <p><strong>UI Location:</strong> Rendered in tracking script based on rules</p>
        <p><strong>Dependencies:</strong> Segmentation Rules, User Authentication</p>

        <h3>Relevant Code Files</h3>
        <ul>
            <li><code>Evoq Platform/Library/Services/Analytics/GoogleAnalyticsProEngine.cs</code></li>
            <li><code>Evoq Content/Connectors/GoogleAnalytics/Components/GoogleAnalyticsConnector.cs</code></li>
            <li><code>Evoq Content/Connectors/GoogleAnalytics/Scripts/connector.js</code></li>
            <li><code>Evoq Content/Connectors/GoogleAnalytics/advanced.htm</code></li>
        </ul>
    </div>

    <div class="section">
        <h2>Code Analysis Summary</h2>
        <p>Based on code review, the Custom Dimensions and Variables feature is implemented with the following capabilities:</p>

        <table>
            <tr>
                <th>Feature</th>
                <th>Implementation Details</th>
            </tr>
            <tr>
                <td>Maximum Custom Variables</td>
                <td><code>MAX_CUSTOM_VARS = 5</code> - Up to 5 custom variables allowed</td>
            </tr>
            <tr>
                <td>Variable Scope</td>
                <td><code>CUSTVAR_OPT_SCOPE = 3</code> - Page-level scope</td>
            </tr>
            <tr>
                <td>Rule-based Targeting</td>
                <td>Variables can target specific pages (TabId) and roles (RoleId)</td>
            </tr>
            <tr>
                <td>Role Options</td>
                <td>RoleId = -1 (All Users), RoleId = -3 (Unauthenticated Users), or specific role ID</td>
            </tr>
            <tr>
                <td>Page Personalization</td>
                <td>Uses localStorage key: <code>Analytics.Page.PageVariantDimension</code></td>
            </tr>
        </table>

        <h3>Script Rendering Logic</h3>
        <div class="code-block">
<span class="keyword">if</span> (scriptTemplate.Contains(<span class="string">"/analytics.js"</span>)) {
    <span class="keyword">// Universal Analytics</span>
    scriptTemplate.Replace(<span class="string">"[CUSTOM_SCRIPT]"</span>, RenderCustomDimensions());
} <span class="keyword">else</span> {
    <span class="keyword">// Classic GA or GA4</span>
    scriptTemplate.Replace(<span class="string">"[CUSTOM_SCRIPT]"</span>, RenderCustomScript(config));
}
        </div>
    </div>

    <div class="section">
        <h2>Test Execution</h2>

        <div class="test-scenario blocked">
            <h3>Test Scenario 1: Add Custom Variable for Specific Role</h3>
            <span class="status blocked">BLOCKED</span>
            <p><strong>Objective:</strong> Test adding a custom variable that targets users with a specific role.</p>
            <p><strong>Steps Taken:</strong></p>
            <ol>
                <li>Logged in as SuperUser (host)</li>
                <li>Navigated to Settings > Connectors</li>
                <li>Located Google Analytics 4 connector</li>
                <li>Clicked Edit to access configuration</li>
                <li>Searched for Advanced Settings / Segmentation Rules option</li>
            </ol>
            <p><strong>Result:</strong> The "Advanced Settings" link that provides access to Segmentation Rules (custom variables) is not visible in the current GA4 connector UI.</p>

            <div class="screenshot">
                <img src="Custom_Dimensions_and_Variables_step04_ga_edit.png" alt="GA4 Connector Edit Panel">
                <div class="caption">GA4 Connector Edit Panel - No Advanced Settings link visible</div>
            </div>
        </div>

        <div class="test-scenario blocked">
            <h3>Test Scenario 2: Add Custom Variable for Specific Page</h3>
            <span class="status blocked">BLOCKED</span>
            <p><strong>Objective:</strong> Test adding a custom variable that targets a specific page.</p>
            <p><strong>Result:</strong> Unable to test - Segmentation Rules UI not accessible.</p>
        </div>

        <div class="test-scenario blocked">
            <h3>Test Scenario 3: Maximum 5 Custom Variables Limit</h3>
            <span class="status blocked">BLOCKED</span>
            <p><strong>Objective:</strong> Verify the system enforces a maximum of 5 custom variables.</p>
            <p><strong>Code Verification:</strong> The code correctly implements this limit:</p>
            <div class="code-block">
<span class="keyword">private const int</span> MAX_CUSTOM_VARS = <span class="number">5</span>;
...
<span class="keyword">if</span> (customVarsCount == MAX_CUSTOM_VARS) <span class="keyword">break</span>;
            </div>
            <p>The UI template (advanced.htm) also enforces this:</p>
            <div class="code-block">
&lt;div <span class="keyword">class</span>=<span class="string">"addRule"</span> data-bind=<span class="string">"visible: rules().length &lt; 5"</span>&gt;
            </div>
            <p><strong>Result:</strong> Code verified but runtime test blocked due to UI limitation.</p>
        </div>

        <div class="test-scenario pass">
            <h3>Test Scenario 4: Verify Page-Level Scope (scope=3)</h3>
            <span class="status pass">PASS (Code Review)</span>
            <p><strong>Objective:</strong> Verify custom variables use page-level scope.</p>
            <p><strong>Verification:</strong> Code confirms page-level scope implementation:</p>
            <div class="code-block">
<span class="keyword">private const int</span> CUSTVAR_OPT_SCOPE = <span class="number">3</span>; <span class="keyword">//page level</span>
...
_gaq.push([<span class="string">'_setCustomVar'</span>, customVarsCount, label, value, CUSTVAR_OPT_SCOPE]);
            </div>
            <p><strong>Result:</strong> Code correctly implements page-level scope (scope=3).</p>
        </div>

        <div class="test-scenario blocked">
            <h3>Test Scenario 5: Custom Dimension for Page Variants</h3>
            <span class="status blocked">BLOCKED</span>
            <p><strong>Objective:</strong> Test custom dimension for page personalization variants.</p>
            <p><strong>Code Verification:</strong> The feature exists for Universal Analytics:</p>
            <div class="code-block">
<span class="keyword">var</span> script =
    <span class="string">"var dimensionName = localStorage.getItem('Analytics.Page.PageVariantDimension');\n"</span> +
    <span class="string">"if (dimensionName != undefined && dimensionName != '') { ga('set', dimensionName, '"</span> +
    personalizedPageName + <span class="string">"'); }"</span>;
            </div>
            <p><strong>Result:</strong> This feature only activates when using the Universal Analytics template (analytics.js), not with the GA4 gtag.js template currently in use.</p>
        </div>

        <div class="test-scenario pass">
            <h3>Test Scenario 6: Validate localStorage for Dimension Names</h3>
            <span class="status pass">PASS (Code Review)</span>
            <p><strong>Objective:</strong> Verify the system uses localStorage for dimension name storage.</p>
            <p><strong>Verification:</strong> Code uses localStorage key <code>Analytics.Page.PageVariantDimension</code>:</p>
            <div class="code-block">
localStorage.getItem(<span class="string">'Analytics.Page.PageVariantDimension'</span>);
            </div>
            <p><strong>Result:</strong> Code correctly implements localStorage for dimension name storage.</p>
        </div>

        <div class="test-scenario pass">
            <h3>Test Scenario 7: GA Tracking Script Rendering</h3>
            <span class="status pass">PASS</span>
            <p><strong>Objective:</strong> Verify GA tracking script is rendered on the page.</p>
            <p><strong>Steps:</strong></p>
            <ol>
                <li>Enabled "Track for Administrators" option</li>
                <li>Saved configuration</li>
                <li>Refreshed page</li>
                <li>Inspected page source for GA scripts</li>
            </ol>
            <p><strong>Result:</strong> GA tracking script is correctly rendered:</p>
            <div class="code-block">
&lt;script async src=<span class="string">"https://www.googletagmanager.com/gtag/js?id=UA-12345678-1"</span>&gt;&lt;/script&gt;
&lt;script&gt;
  window.dataLayer = window.dataLayer || [];
  <span class="keyword">function</span> gtag(){dataLayer.push(arguments);}
  gtag(<span class="string">'js'</span>, <span class="keyword">new</span> Date());
  gtag(<span class="string">'config'</span>, <span class="string">'UA-12345678-1'</span>);
&lt;/script&gt;
            </div>

            <div class="screenshot">
                <img src="Custom_Dimensions_and_Variables_step06_track_admins_enabled.png" alt="Track for Administrators Enabled">
                <div class="caption">Track for Administrators option enabled</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Key Findings</h2>

        <div class="findings">
            <h4>Critical Issue: Advanced Settings UI Not Accessible</h4>
            <p>The GA4 connector ("Google Analytics 4") does not display the "Advanced Settings" link that would provide access to the Segmentation Rules configuration. This link exists in the codebase:</p>
            <ul>
                <li><code>connector.htm</code>: Contains <code>&lt;a class="advancedSetting"&gt;</code></li>
                <li><code>connector.js</code>: Handles click event to open Advanced Settings dialog</li>
                <li><code>advanced.htm</code>: Contains the full Segmentation Rules UI with Label, Value, Page, and Role fields</li>
            </ul>
            <p>However, the current GA4 connector panel only shows:</p>
            <ul>
                <li>Measurement ID field</li>
                <li>Track for Administrators checkbox</li>
                <li>Cancel, Save, Delete Connection buttons</li>
            </ul>
        </div>

        <div class="findings">
            <h4>Configuration Template Mismatch</h4>
            <p>The system is configured with a Universal Analytics tracking ID (UA-12345678-1) but uses the GA4 template (gtag.js) instead of the Universal Analytics template (analytics.js). This affects which custom dimension rendering method is used:</p>
            <ul>
                <li><strong>gtag.js template</strong>: Uses <code>RenderCustomScript(config)</code> - relies on segmentation rules</li>
                <li><strong>analytics.js template</strong>: Uses <code>RenderCustomDimensions()</code> - includes localStorage page variants</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>Test Screenshots</h2>

        <div class="screenshot">
            <img src="Custom_Dimensions_and_Variables_step01_homepage.png" alt="Homepage">
            <div class="caption">Step 1: Initial Homepage View</div>
        </div>

        <div class="screenshot">
            <img src="Custom_Dimensions_and_Variables_step02_logged_in.png" alt="Logged In">
            <div class="caption">Step 2: Logged in as SuperUser</div>
        </div>

        <div class="screenshot">
            <img src="Custom_Dimensions_and_Variables_step03_connectors_page.png" alt="Connectors Page">
            <div class="caption">Step 3: Connectors Configuration Page</div>
        </div>

        <div class="screenshot">
            <img src="Custom_Dimensions_and_Variables_step05_ga4_no_advanced_settings.png" alt="GA4 No Advanced Settings">
            <div class="caption">Step 5: GA4 Connector - No Advanced Settings Link</div>
        </div>

        <div class="screenshot">
            <img src="Custom_Dimensions_and_Variables_step07_save_success.png" alt="Save Success">
            <div class="caption">Step 7: Configuration Save Success</div>
        </div>

        <div class="screenshot">
            <img src="Custom_Dimensions_and_Variables_step08_tracking_script.png" alt="Tracking Script">
            <div class="caption">Step 8: Page with GA Tracking Script</div>
        </div>
    </div>

    <div class="section">
        <h2>Test Summary</h2>

        <table class="summary-table">
            <tr>
                <td>Total Test Scenarios</td>
                <td>7</td>
            </tr>
            <tr>
                <td>Passed</td>
                <td>3 (Code Review verified)</td>
            </tr>
            <tr>
                <td>Failed</td>
                <td>0</td>
            </tr>
            <tr>
                <td>Blocked</td>
                <td>4 (UI not accessible)</td>
            </tr>
        </table>

        <h3>Recommendations</h3>
        <ol>
            <li><strong>Investigate GA4 Connector Template</strong>: The GA4 connector may be using a different/simplified template that excludes the Advanced Settings feature. Review if this is intentional for GA4 or a regression.</li>
            <li><strong>Restore Advanced Settings Link</strong>: If Segmentation Rules should be available for GA4, ensure the advancedSetting link is included in the GA4 connector template.</li>
            <li><strong>Template Selection Logic</strong>: Review the logic that selects between SiteAnalytics.config (UA) and SiteAnalytics.GA4.config to ensure correct template is used based on tracking ID format.</li>
            <li><strong>Documentation Update</strong>: If the Segmentation Rules feature is deprecated for GA4, update documentation to reflect this limitation.</li>
        </ol>
    </div>

    <div class="section">
        <h2>Environment Details</h2>
        <table>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Website URL</td>
                <td>http://localhost:8081</td>
            </tr>
            <tr>
                <td>Test User</td>
                <td>host (SuperUser)</td>
            </tr>
            <tr>
                <td>Browser Viewport</td>
                <td>1920x1080</td>
            </tr>
            <tr>
                <td>Configured Tracking ID</td>
                <td>UA-12345678-1</td>
            </tr>
            <tr>
                <td>Active Template</td>
                <td>SiteAnalytics.GA4.config (gtag.js)</td>
            </tr>
        </table>
    </div>

    <footer style="text-align: center; margin-top: 30px; color: #5f6368; font-size: 12px;">
        <p>Generated by Evoq Extensions Tester | December 30, 2025</p>
    </footer>
</body>
</html>
