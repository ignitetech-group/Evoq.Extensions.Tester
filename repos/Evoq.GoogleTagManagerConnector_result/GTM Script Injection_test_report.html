<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTM Script Injection - Test Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }
        h2 {
            color: #0066cc;
            margin-top: 30px;
        }
        h3 {
            color: #444;
        }
        .feature-info {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .test-case {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .pass {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }
        .fail {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.2em;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
        }
        .status-pass {
            background-color: #28a745;
        }
        .status-fail {
            background-color: #dc3545;
        }
        .screenshot {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .steps {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .code-block {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .observations {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 30px;
            border-left: 4px solid #ffc107;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .summary-table th {
            background-color: #0066cc;
            color: white;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>GTM Script Injection - Test Report</h1>

    <div class="feature-info">
        <h2>Feature Information</h2>
        <p><strong>Feature Name:</strong> GTM Script Injection</p>
        <p><strong>Extension:</strong> Evoq.GoogleTagManagerConnector</p>
        <p><strong>Description:</strong> Injects Google Tag Manager JavaScript code into page headers for tracking and analytics</p>
        <p><strong>UI Location:</strong> Settings &gt; Connectors &gt; Google Tag Manager</p>
        <p><strong>Feature Priority:</strong> Top</p>
        <p><strong>Test Date:</strong> January 6, 2026</p>
    </div>

    <h2>Test Summary</h2>
    <table class="summary-table">
        <tr>
            <th>Test Scenario</th>
            <th>Status</th>
        </tr>
        <tr>
            <td>No script injection when container ID is empty</td>
            <td><span class="status-badge status-pass">PASS</span></td>
        </tr>
        <tr>
            <td>GTM script appears when container is configured</td>
            <td><span class="status-badge status-pass">PASS</span></td>
        </tr>
        <tr>
            <td>Container ID correctly substituted in script</td>
            <td><span class="status-badge status-pass">PASS</span></td>
        </tr>
        <tr>
            <td>Script injects on CDefault pages (public and admin)</td>
            <td><span class="status-badge status-pass">PASS</span></td>
        </tr>
        <tr>
            <td>Script injection reflects configuration changes</td>
            <td><span class="status-badge status-pass">PASS</span></td>
        </tr>
        <tr>
            <td>Invalid container ID validation</td>
            <td><span class="status-badge status-pass">PASS</span></td>
        </tr>
    </table>

    <h2>Detailed Test Results</h2>

    <!-- Test 1: No script when empty -->
    <div class="test-case">
        <h3>Test 1: No Script Injection When Container ID is Empty</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>

        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Navigate to Settings &gt; Connectors</li>
                <li>Verify Google Tag Manager has no container ID configured</li>
                <li>Navigate to public site page</li>
                <li>Check page source for GTM script</li>
            </ol>
        </div>

        <p><strong>Expected Result:</strong> No GTM script should be present in page head when container ID is empty</p>
        <p><strong>Actual Result:</strong> GTM script was NOT found in page source (hasGTM: false)</p>

        <div class="code-block">
JavaScript Check Result:
{
  "hasGTM": false,
  "headSnippet": "...standard DNN CSS/JS files, no GTM script..."
}
        </div>

        <p><strong>Screenshot:</strong></p>
        <img src="GTM_Script_Injection_step02_no_script_empty_container.png" alt="No script with empty container" class="screenshot">
    </div>

    <!-- Test 2: GTM Script Appears When Configured -->
    <div class="test-case">
        <h3>Test 2: GTM Script Appears When Container is Configured</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>

        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Navigate to Settings &gt; Connectors</li>
                <li>Click "Connect" on Google Tag Manager</li>
                <li>Enter valid container ID: GTM-P7RJMM</li>
                <li>Click Save</li>
                <li>Navigate to public site page</li>
                <li>Check page source for GTM script</li>
            </ol>
        </div>

        <p><strong>Expected Result:</strong> GTM script should be present in page head with configured container ID</p>
        <p><strong>Actual Result:</strong> GTM script was found with correct container ID (hasGTM: true)</p>

        <div class="code-block">
JavaScript Check Result:
{
  "hasGTM": true,
  "containerId": "GTM-P7RJMM",
  "scriptSnippet": "&lt;script async=\"\" src=\"https://www.googletagmanager.com/gtm.js?id=GTM-P7RJMM\"&gt;&lt;/script&gt;"
}
        </div>

        <p><strong>Screenshots:</strong></p>
        <img src="GTM_Script_Injection_step03_entering_container_id.png" alt="Entering container ID" class="screenshot">
        <img src="GTM_Script_Injection_step05_container_saved_success.png" alt="Container saved successfully" class="screenshot">
        <img src="GTM_Script_Injection_step06_script_injected_verified.png" alt="Script injection verified" class="screenshot">
    </div>

    <!-- Test 3: Container ID Substitution -->
    <div class="test-case">
        <h3>Test 3: Container ID Correctly Substituted in Script</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>

        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Configure GTM with container ID: GTM-P7RJMM</li>
                <li>Navigate to public page</li>
                <li>Verify the exact container ID appears in the injected script URL</li>
            </ol>
        </div>

        <p><strong>Expected Result:</strong> The [CONTAINERID] placeholder should be replaced with actual container ID</p>
        <p><strong>Actual Result:</strong> Script contains correct URL: https://www.googletagmanager.com/gtm.js?id=GTM-P7RJMM</p>

        <p><strong>Code Analysis:</strong> The script template in GoogleTagManager.config uses [CONTAINERID] placeholder which is replaced in TagManagerModule.cs line 80:</p>
        <div class="code-block">
scriptContent = scriptContent?.Replace("[CONTAINERID]", containerId);
        </div>
    </div>

    <!-- Test 4: CDefault Pages -->
    <div class="test-case">
        <h3>Test 4: Script Injects on CDefault Pages</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>

        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Configure GTM with valid container ID</li>
                <li>Navigate to public home page - verify GTM present</li>
                <li>Navigate to Host admin page - verify GTM present</li>
            </ol>
        </div>

        <p><strong>Expected Result:</strong> GTM script should inject on all CDefault pages (both public and admin pages in DNN)</p>
        <p><strong>Actual Result:</strong> GTM script was found on both public page and Host admin page</p>

        <div class="code-block">
Public Page (http://localhost:8081/en-us/):
{ "hasGTM": true, "containerId": "GTM-P7RJMM" }

Host Admin Page (http://localhost:8081/Host/Host-Settings):
{ "hasGTM": true, "containerId": "GTM-P7RJMM" }
        </div>

        <p><strong>Code Reference:</strong> TagManagerModule.cs line 46:</p>
        <div class="code-block">
if (!(page is CDefault)) return;
        </div>

        <p><strong>Screenshot:</strong></p>
        <img src="GTM_Script_Injection_step07_host_page_gtm_present.png" alt="GTM on Host page" class="screenshot">
    </div>

    <!-- Test 5: Configuration Changes -->
    <div class="test-case">
        <h3>Test 5: Script Injection Reflects Configuration Changes</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>

        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Clear the container ID (set to empty)</li>
                <li>Save configuration</li>
                <li>Navigate to public page</li>
                <li>Verify GTM script is no longer present</li>
                <li>Re-configure with valid container ID</li>
                <li>Verify GTM script is injected again</li>
            </ol>
        </div>

        <p><strong>Expected Result:</strong> Configuration changes should be reflected immediately on page refresh</p>
        <p><strong>Actual Result:</strong> After clearing container ID, GTM script was removed. After re-configuring, script was injected again.</p>

        <div class="code-block">
After clearing container ID:
{ "hasGTM": false }

After re-configuring with GTM-P7RJMM:
{ "hasGTM": true, "containerId": "GTM-P7RJMM" }
        </div>

        <p><strong>Screenshots:</strong></p>
        <img src="GTM_Script_Injection_step09_container_cleared.png" alt="Container cleared" class="screenshot">
        <img src="GTM_Script_Injection_step10_no_script_after_clearing.png" alt="No script after clearing" class="screenshot">
    </div>

    <!-- Test 6: Invalid Container Validation -->
    <div class="test-case">
        <h3>Test 6: Invalid Container ID Validation</h3>
        <p><strong>Status:</strong> <span class="pass">PASS</span></p>

        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Enter invalid/non-existent container ID (GTM-NDJKHJ)</li>
                <li>Click Save</li>
                <li>Observe validation error message</li>
            </ol>
        </div>

        <p><strong>Expected Result:</strong> Invalid container IDs should be rejected with an error message</p>
        <p><strong>Actual Result:</strong> Error message displayed: "The Container Id is invalid or container hasn't been published yet."</p>

        <p><strong>Code Reference:</strong> GoogleTagManagerConnector.cs validates by making HTTP request to Google:</p>
        <div class="code-block">
var verifyUrl = string.Format(Constants.VerifyUrl, containerId);
// VerifyUrl = "https://www.googletagmanager.com/gtm.js?id={0}"
        </div>

        <p><strong>Screenshot:</strong></p>
        <img src="GTM_Script_Injection_step04_invalid_container_error_full.png" alt="Invalid container validation" class="screenshot">
    </div>

    <div class="observations">
        <h2>Observations</h2>
        <ul>
            <li><strong>Script Template Caching:</strong> The GTM script template is cached in DataCache (TagManagerModule.cs lines 65-78). This improves performance by not reading the config file on every request.</li>
            <li><strong>GA Integration Option:</strong> The connector includes a toggle "This GTM container has already been configured to add the Google Analytics Script" which sets the UseTagManagerForGA setting. When enabled, it passes 'true' to the eaSendGaEvents dataLayer variable.</li>
            <li><strong>Page Variant Tracking:</strong> The script includes personalization data via the [DATALAYER_INIT] placeholder which adds the current page variant name (for A/B testing scenarios).</li>
            <li><strong>Portal-Specific Configuration:</strong> GTM container ID is stored per-portal, allowing different container IDs for multi-portal DNN installations.</li>
        </ul>
    </div>

    <h2>Conclusion</h2>
    <p>All test scenarios for the GTM Script Injection feature <strong>PASSED</strong>. The feature correctly:</p>
    <ul>
        <li>Injects GTM script only when a valid container ID is configured</li>
        <li>Substitutes the correct container ID in the script URL</li>
        <li>Injects on all CDefault pages (public and admin)</li>
        <li>Reflects configuration changes immediately</li>
        <li>Validates container IDs against Google's servers</li>
    </ul>

</body>
</html>
