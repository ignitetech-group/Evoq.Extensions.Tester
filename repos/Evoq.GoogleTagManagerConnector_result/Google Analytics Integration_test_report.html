<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Analytics Integration - Test Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0 0 10px 0;
        }
        .header p {
            margin: 5px 0;
            opacity: 0.9;
        }
        .summary-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .summary-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stat {
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        .stat.passed {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        .stat.failed {
            background: #ffebee;
            border: 2px solid #f44336;
        }
        .stat.total {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        .test-scenario {
            background: white;
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .scenario-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .scenario-header.passed {
            background: #4caf50;
            color: white;
        }
        .scenario-header.failed {
            background: #f44336;
            color: white;
        }
        .scenario-header h3 {
            margin: 0;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .status-badge.passed {
            background: rgba(255,255,255,0.3);
        }
        .status-badge.failed {
            background: rgba(255,255,255,0.3);
        }
        .scenario-content {
            padding: 20px;
        }
        .steps {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .steps h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .steps li {
            margin-bottom: 8px;
        }
        .screenshots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .screenshot {
            text-align: center;
        }
        .screenshot img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .screenshot p {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }
        .observations {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
        }
        .observations h4 {
            margin: 0 0 10px 0;
            color: #e65100;
        }
        .code-section {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
        }
        .code-section h4 {
            color: #81d4fa;
            margin: 0 0 10px 0;
        }
        .code-section pre {
            margin: 0;
            white-space: pre-wrap;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Google Analytics Integration - Test Report</h1>
        <p><strong>Extension:</strong> Evoq.GoogleTagManagerConnector</p>
        <p><strong>Feature:</strong> Google Analytics Integration (Feature 4 of 8)</p>
        <p><strong>Priority:</strong> High</p>
        <p><strong>Test Date:</strong> December 30, 2025</p>
    </div>

    <div class="summary-box">
        <h2>Feature Description</h2>
        <p>This feature provides an option to use Google Tag Manager for Google Analytics tracking instead of the native GA implementation. When enabled, it sets the <code>eaSendGaEvents</code> flag in the GTM dataLayer to <code>true</code>, allowing GTM to handle GA event tracking.</p>

        <h3>Test Summary</h3>
        <div class="summary-stats">
            <div class="stat total">
                <div class="stat-number">6</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat passed">
                <div class="stat-number">6</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat failed">
                <div class="stat-number">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
    </div>

    <div class="code-section">
        <h4>Key Code Implementation (GoogleTagManager.config)</h4>
        <pre>&lt;script type="text/javascript"&gt;
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'eaSendGaEvents':[USETAGMANAGERFORGA][DATALAYER_INIT]});
  w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});...
  })(window,document,'script','dataLayer','[CONTAINERID]');
&lt;/script&gt;</pre>
    </div>

    <!-- Test Scenario 1 -->
    <div class="test-scenario">
        <div class="scenario-header passed">
            <h3>Test 1: Enable GA through GTM Checkbox</h3>
            <span class="status-badge passed">PASSED</span>
        </div>
        <div class="scenario-content">
            <div class="steps">
                <h4>Steps Taken</h4>
                <ol>
                    <li>Navigated to Admin > Settings > Connectors</li>
                    <li>Opened Google Tag Manager configuration panel</li>
                    <li>Entered a valid Container ID (GTM-5CVQBG)</li>
                    <li>Enabled the "Use Google Tag Manager for Google Analytics" checkbox</li>
                    <li>Clicked Save button</li>
                    <li>Verified the configuration was saved successfully</li>
                </ol>
            </div>
            <div class="screenshots">
                <div class="screenshot">
                    <img src="Google Analytics Integration_step04_ga_checkbox_enabled.png" alt="GA Checkbox Enabled">
                    <p>GA checkbox toggled to ON state</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step06_save_success.png" alt="Save Success">
                    <p>Configuration saved successfully</p>
                </div>
            </div>
            <div class="observations">
                <h4>Observations</h4>
                <p>The checkbox toggle works smoothly. When enabled, the toggle switches to "On" position and the UI updates immediately to reflect the change.</p>
            </div>
        </div>
    </div>

    <!-- Test Scenario 2 -->
    <div class="test-scenario">
        <div class="scenario-header passed">
            <h3>Test 2: Disable GA through GTM Checkbox</h3>
            <span class="status-badge passed">PASSED</span>
        </div>
        <div class="scenario-content">
            <div class="steps">
                <h4>Steps Taken</h4>
                <ol>
                    <li>With GTM configured and GA enabled, opened the configuration panel</li>
                    <li>Clicked the "Use Google Tag Manager for Google Analytics" toggle to disable</li>
                    <li>Saved the configuration</li>
                    <li>Verified the toggle switched to "Off" position</li>
                </ol>
            </div>
            <div class="screenshots">
                <div class="screenshot">
                    <img src="Google Analytics Integration_step09_edit_showing_off.png" alt="Edit Showing Off">
                    <p>Configuration panel showing GA toggle in OFF state</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step13_toggle_off.png" alt="Toggle Off">
                    <p>GA toggle disabled after save</p>
                </div>
            </div>
            <div class="observations">
                <h4>Observations</h4>
                <p>Disabling the GA checkbox works correctly. The toggle visually changes to "Off" and the setting is persisted correctly.</p>
            </div>
        </div>
    </div>

    <!-- Test Scenario 3 -->
    <div class="test-scenario">
        <div class="scenario-header passed">
            <h3>Test 3: Verify eaSendGaEvents Flag = true When Enabled</h3>
            <span class="status-badge passed">PASSED</span>
        </div>
        <div class="scenario-content">
            <div class="steps">
                <h4>Steps Taken</h4>
                <ol>
                    <li>Configured GTM with valid Container ID (GTM-5CVQBG)</li>
                    <li>Enabled the "Use Google Tag Manager for Google Analytics" option</li>
                    <li>Saved the configuration</li>
                    <li>Navigated to the site homepage</li>
                    <li>Executed JavaScript to check dataLayer: <code>JSON.stringify(dataLayer.find(d => 'eaSendGaEvents' in d))</code></li>
                    <li>Verified eaSendGaEvents was set to true</li>
                </ol>
            </div>
            <div class="screenshots">
                <div class="screenshot">
                    <img src="Google Analytics Integration_step11_save_on_success.png" alt="Save On Success">
                    <p>GA enabled and saved</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step12_datalayer_true.png" alt="DataLayer True">
                    <p>dataLayer showing eaSendGaEvents: true</p>
                </div>
            </div>
            <div class="code-section">
                <h4>Verification Result</h4>
                <pre>dataLayer entry found: {"eaSendGaEvents":true,"pageVariant":"Default"}</pre>
            </div>
            <div class="observations">
                <h4>Observations</h4>
                <p>When the GA checkbox is enabled, the GTM script correctly injects <code>eaSendGaEvents: true</code> into the dataLayer. This allows GTM to handle GA event tracking. The pageVariant is also correctly set to "Default".</p>
            </div>
        </div>
    </div>

    <!-- Test Scenario 4 -->
    <div class="test-scenario">
        <div class="scenario-header passed">
            <h3>Test 4: Verify Flag = false When Disabled</h3>
            <span class="status-badge passed">PASSED</span>
        </div>
        <div class="scenario-content">
            <div class="steps">
                <h4>Steps Taken</h4>
                <ol>
                    <li>With GTM configured, disabled the GA checkbox</li>
                    <li>Saved the configuration</li>
                    <li>Navigated to the site homepage</li>
                    <li>Executed JavaScript to check dataLayer</li>
                    <li>Verified eaSendGaEvents was set to false</li>
                </ol>
            </div>
            <div class="screenshots">
                <div class="screenshot">
                    <img src="Google Analytics Integration_step08_datalayer_false.png" alt="DataLayer False">
                    <p>dataLayer showing eaSendGaEvents: false (initial state)</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step14_datalayer_false_verified.png" alt="DataLayer False Verified">
                    <p>Verified eaSendGaEvents: false after disabling</p>
                </div>
            </div>
            <div class="code-section">
                <h4>Verification Result</h4>
                <pre>dataLayer entry found: {"eaSendGaEvents":false,"pageVariant":"Default"}</pre>
            </div>
            <div class="observations">
                <h4>Observations</h4>
                <p>When the GA checkbox is disabled, the dataLayer correctly shows <code>eaSendGaEvents: false</code>. This indicates to GTM that GA events should not be sent through the tag manager.</p>
            </div>
        </div>
    </div>

    <!-- Test Scenario 5 -->
    <div class="test-scenario">
        <div class="scenario-header passed">
            <h3>Test 5: Automatic Disable When Container ID is Cleared</h3>
            <span class="status-badge passed">PASSED</span>
        </div>
        <div class="scenario-content">
            <div class="steps">
                <h4>Steps Taken</h4>
                <ol>
                    <li>Started with GTM configured (Container ID and GA checkbox enabled)</li>
                    <li>Opened the GTM configuration panel</li>
                    <li>Cleared the Container ID field</li>
                    <li>Saved the configuration</li>
                    <li>Navigated to the homepage</li>
                    <li>Verified that dataLayer was not present (GTM script not injected)</li>
                </ol>
            </div>
            <div class="screenshots">
                <div class="screenshot">
                    <img src="Google Analytics Integration_step15_before_clear_container.png" alt="Before Clear">
                    <p>GTM configuration before clearing Container ID</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step16_container_cleared.png" alt="Container Cleared">
                    <p>Container ID field cleared</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step17_no_datalayer_after_clear.png" alt="No DataLayer">
                    <p>Page with no GTM script (dataLayer not found)</p>
                </div>
            </div>
            <div class="code-section">
                <h4>Code Behavior (GoogleTagManagerConnector.cs:87-89)</h4>
                <pre>if (string.IsNullOrEmpty(containerId))
{
    PortalController.UpdatePortalSetting(portalId, Constants.UseTagManagerForGASettingName, "False", true);
}</pre>
            </div>
            <div class="observations">
                <h4>Observations</h4>
                <p>When the Container ID is cleared, the code automatically sets the UseTagManagerForGA setting to "False". Additionally, without a Container ID, the GTM script is not injected into the page at all (as verified by the missing dataLayer). This is the expected behavior to prevent GTM-related code from running without a valid container.</p>
            </div>
        </div>
    </div>

    <!-- Test Scenario 6 -->
    <div class="test-scenario">
        <div class="scenario-header passed">
            <h3>Test 6: Checkbox State Persists After Save</h3>
            <span class="status-badge passed">PASSED</span>
        </div>
        <div class="scenario-content">
            <div class="steps">
                <h4>Steps Taken</h4>
                <ol>
                    <li>Configured GTM with Container ID (GTM-5CVQBG)</li>
                    <li>Enabled the GA checkbox</li>
                    <li>Saved the configuration</li>
                    <li>Re-opened the configuration panel</li>
                    <li>Verified the GA checkbox was still in the enabled state</li>
                    <li>Repeated test with checkbox disabled to verify persistence</li>
                </ol>
            </div>
            <div class="screenshots">
                <div class="screenshot">
                    <img src="Google Analytics Integration_step07_gtm_connected_on.png" alt="GTM Connected On">
                    <p>GTM configured with GA enabled - state persisted</p>
                </div>
                <div class="screenshot">
                    <img src="Google Analytics Integration_step10_toggle_on.png" alt="Toggle On">
                    <p>Checkbox state verified after reopening panel</p>
                </div>
            </div>
            <div class="observations">
                <h4>Observations</h4>
                <p>The checkbox state correctly persists after save. Whether enabled or disabled, the setting is properly stored in the portal settings and restored when the configuration panel is opened again.</p>
            </div>
        </div>
    </div>

    <div class="summary-box">
        <h2>Overall Test Results</h2>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr style="background: #f0f0f0;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Test Scenario</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">Enable GA through GTM checkbox</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; color: #4caf50; font-weight: bold;">PASSED</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">Disable GA through GTM checkbox</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; color: #4caf50; font-weight: bold;">PASSED</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">Verify eaSendGaEvents flag in dataLayer when enabled</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; color: #4caf50; font-weight: bold;">PASSED</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">Verify flag is false when disabled</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; color: #4caf50; font-weight: bold;">PASSED</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">Test automatic disable when container ID is cleared</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; color: #4caf50; font-weight: bold;">PASSED</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">Verify checkbox state persists after save</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; color: #4caf50; font-weight: bold;">PASSED</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="summary-box">
        <h2>Technical Notes</h2>
        <ul>
            <li><strong>Container ID Validation:</strong> The system validates container IDs against Google's GTM API before saving. Invalid or unpublished containers are rejected.</li>
            <li><strong>Setting Storage:</strong> Settings are stored in DNN portal settings using keys <code>GTMContainerId</code> and <code>GTMUseTagManagerForGA</code>.</li>
            <li><strong>Script Injection:</strong> The GTM script is injected via an HTTP module (TagManagerModule) during the PreRender phase of page processing.</li>
            <li><strong>Default Value:</strong> When UseTagManagerForGA setting doesn't exist, the default value is "false".</li>
        </ul>
    </div>

    <div class="footer">
        <p>Test Report Generated: December 30, 2025</p>
        <p>Testing performed using Playwright MCP browser automation</p>
        <p>Evoq.GoogleTagManagerConnector - Google Analytics Integration Feature</p>
    </div>
</body>
</html>
