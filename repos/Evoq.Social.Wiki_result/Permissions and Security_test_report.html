<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permissions and Security - Test Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }
        h2 {
            color: #0066cc;
            margin-top: 30px;
        }
        h3 {
            color: #444;
        }
        .feature-info {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .pass {
            background-color: #28a745;
            color: white;
        }
        .fail {
            background-color: #dc3545;
            color: white;
        }
        .screenshot {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .steps {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .issue {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
        }
        .observations {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #f8f9fa;
        }
        .summary {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .stat {
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-pass {
            background: #d4edda;
            color: #155724;
        }
        .stat-fail {
            background: #f8d7da;
            color: #721c24;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Permissions and Security - Test Report</h1>

    <div class="feature-info">
        <h2>Feature Information</h2>
        <table>
            <tr><th>Extension</th><td>Evoq.Social.Wiki</td></tr>
            <tr><th>Feature Name</th><td>Permissions and Security</td></tr>
            <tr><th>Feature Priority</th><td>Top</td></tr>
            <tr><th>Description</th><td>Control access to wiki features based on user roles and permissions</td></tr>
            <tr><th>UI Location</th><td>Module Settings > Permissions tab</td></tr>
            <tr><th>Test Date</th><td>January 6, 2026</td></tr>
        </table>
    </div>

    <div class="summary">
        <h2>Test Summary</h2>
        <div class="summary-stats">
            <div class="stat stat-pass">
                <div class="stat-number">7</div>
                <div>PASS</div>
            </div>
            <div class="stat stat-fail">
                <div class="stat-number">1</div>
                <div>FAIL</div>
            </div>
        </div>
    </div>

    <h2>Test Cases</h2>

    <!-- Test 1: View Permissions -->
    <div class="test-case">
        <h3>Test 1: View Permissions</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Test that the View Module permission column is visible and correctly displays permissions for all roles.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Navigate to Wiki page</li>
                <li>Enter edit mode</li>
                <li>Open module settings for Wiki module (433)</li>
                <li>Click on Permissions tab</li>
                <li>Verify View Module column is present with permission states for all roles</li>
            </ol>
        </div>
        <p><strong>Result:</strong> View Module column is present and shows lock icons (inherited) or checkboxes for explicit permissions. The "Inherit View permissions from Page" checkbox is available and functional.</p>
        <img src="Permissions_and_Security_step04_permissions_overview.png" alt="Permissions Overview" class="screenshot">
    </div>

    <!-- Test 2: Create Permissions -->
    <div class="test-case">
        <h3>Test 2: Create Permissions (Content Permission)</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Test that Content permission can be toggled for roles to control wiki article creation.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>In Permissions tab, locate Registered Users row</li>
                <li>Click on the Content column checkbox/icon</li>
                <li>Verify permission state changes from "Not Specified" to "Permission Granted"</li>
            </ol>
        </div>
        <p><strong>Result:</strong> Successfully toggled Content permission for Registered Users. The checkmark appeared indicating permission was granted.</p>
        <img src="Permissions_and_Security_step07_content_permission_granted.png" alt="Content Permission Granted" class="screenshot">
    </div>

    <!-- Test 3: Edit Permissions -->
    <div class="test-case">
        <h3>Test 3: Edit Permissions (Edit Module)</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Test that Edit Module permission column exists and can be configured.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>In Permissions tab, verify Edit Module column is present</li>
                <li>Observe permission states for different roles</li>
            </ol>
        </div>
        <p><strong>Result:</strong> Edit Module column is present. Administrators, Content Editors, and Content Managers have this permission granted (lock icons indicating inherited permissions).</p>
        <img src="Permissions_and_Security_step06_permissions_grid.png" alt="Edit Module Permissions" class="screenshot">
    </div>

    <!-- Test 4: Moderate Permissions -->
    <div class="test-case">
        <h3>Test 4: Moderate Permissions</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Test the Moderators permission column which controls moderation capabilities.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>In Permissions tab, locate Moderators column</li>
                <li>Verify Community Manager and Moderators roles have explicit permissions</li>
                <li>Verify other roles can have this permission toggled</li>
            </ol>
        </div>
        <p><strong>Result:</strong> Moderators column is present. Community Manager and Moderators roles have checkmarks indicating explicit "Moderators" permission. The permission can be toggled via the grid interface.</p>
        <img src="Permissions_and_Security_step06_permissions_grid.png" alt="Moderators Permissions" class="screenshot">
    </div>

    <!-- Test 5: Group Mode Permissions -->
    <div class="test-case">
        <h3>Test 5: Group Mode Permissions</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Test that permissions can be filtered by group.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>In Permissions tab, locate "Filter By Group" dropdown</li>
                <li>Verify dropdown has options for "< All Roles >" and "< Global Roles >"</li>
            </ol>
        </div>
        <p><strong>Result:</strong> Filter By Group dropdown is present with options including "< All Roles >" and "< Global Roles >". This allows filtering the permission grid by role groups.</p>
        <img src="Permissions_and_Security_step06_permissions_grid.png" alt="Group Filter" class="screenshot">
    </div>

    <!-- Test 6: Anonymous User Access - BUG -->
    <div class="test-case">
        <h3>Test 6: Anonymous User Access</h3>
        <p><span class="status fail">FAIL</span></p>
        <p><strong>Description:</strong> Test configuring permissions for Unauthenticated Users (anonymous visitors).</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>In Permissions tab, select "Unauthenticated Users" from the Select Role dropdown</li>
                <li>Click "Add" button to add this role to the permissions grid</li>
                <li>Observe the result</li>
            </ol>
        </div>
        <div class="issue">
            <strong>BUG FOUND:</strong> When attempting to add "Unauthenticated Users" role to the module permissions, the system throws a critical error: "Object reference not set to an instance of an object."
            <br><br>
            <strong>Error URL:</strong> http://localhost:8081/Default.aspx?tabid=40&error=Object+reference+not+set+to+an+instance+of+an+object.
            <br><br>
            <strong>Impact:</strong> Administrators cannot configure anonymous user access for Wiki modules, preventing proper setup of public-facing wiki pages.
        </div>
        <img src="Permissions_and_Security_step05_error_adding_unauthenticated.png" alt="Error Adding Unauthenticated Users" class="screenshot">
    </div>

    <!-- Test 7: Permission Inheritance -->
    <div class="test-case">
        <h3>Test 7: Permission Inheritance</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Test the "Inherit View permissions from Page" checkbox functionality.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>In Permissions tab, locate the "Inherit View permissions from Page" checkbox</li>
                <li>Verify it is checked by default</li>
                <li>Click to uncheck the checkbox</li>
                <li>Observe changes in the View Module column</li>
            </ol>
        </div>
        <p><strong>Result:</strong> The checkbox successfully toggles permission inheritance. When unchecked, View Module permissions that were showing as "Not Specified" (inherited) changed to show explicit permission states.</p>
        <img src="Permissions_and_Security_step08_inheritance_unchecked.png" alt="Permission Inheritance Unchecked" class="screenshot">
    </div>

    <!-- Test 8: Anti-Forgery Validation -->
    <div class="test-case">
        <h3>Test 8: Anti-Forgery Validation</h3>
        <p><span class="status pass">PASS</span></p>
        <p><strong>Description:</strong> Verify that API endpoints are protected with anti-forgery tokens.</p>
        <div class="steps">
            <strong>Steps:</strong>
            <ol>
                <li>Review ContentController.cs code</li>
                <li>Verify [ValidateAntiForgeryToken] attributes are present on POST/PUT/DELETE methods</li>
            </ol>
        </div>
        <p><strong>Result:</strong> Code review confirms that the ContentController.cs file includes [ValidateAntiForgeryToken] attribute on all write operations (POST, PUT, DELETE methods). This protects against CSRF attacks.</p>
        <p><strong>Relevant Code Files:</strong></p>
        <ul>
            <li>DesktopModules/DNNCorp/Wiki/Services/ContentController.cs - Contains API endpoints with ValidateAntiForgeryToken</li>
            <li>DesktopModules/DNNCorp/Wiki/Components/Common/ModuleSecurity.cs - Implements CanCreateArticle() permission check</li>
            <li>DesktopModules/DNNCorp/SocialLibrary/Components/Common/ModuleSecurityBase.cs - Base class with CanView, CanEdit, CanModerate properties</li>
        </ul>
    </div>

    <div class="observations">
        <h2>Observations</h2>
        <ul>
            <li><strong>Permission Grid UI:</strong> The permissions grid provides a comprehensive view of all permission types (View Module, Content, Delete, Export, Import, Manage, Moderators, Edit Module) across multiple roles.</li>
            <li><strong>Lock Icons:</strong> Lock icons indicate inherited permissions that cannot be directly modified for certain roles (like Administrators).</li>
            <li><strong>Role Selection:</strong> The Select Role dropdown allows adding additional roles beyond the default set, though the "Unauthenticated Users" option causes errors.</li>
            <li><strong>User-based Permissions:</strong> A "Display Name" field with Add button allows adding permissions for specific users, though this was not tested.</li>
            <li><strong>Code-level Security:</strong> The ModuleSecurity class extends ModuleSecurityBase and implements CanCreateArticle() which combines CanModerate OR _hasCreatePage permissions.</li>
        </ul>
    </div>

    <div class="feature-info">
        <h2>Test Environment</h2>
        <table>
            <tr><th>Website URL</th><td>http://localhost:8081</td></tr>
            <tr><th>User Account</th><td>SuperUser Account (host)</td></tr>
            <tr><th>Browser</th><td>Playwright-controlled browser</td></tr>
            <tr><th>Code Repository</th><td>C:\DNN\Evoq.Extensions.Tester\repos\Dnn.Evoq.Social</td></tr>
        </table>
    </div>

</body>
</html>
