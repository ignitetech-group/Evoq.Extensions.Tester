<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report: Login As User (Impersonation)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #0078d4;
            padding-bottom: 10px;
        }
        h2 {
            color: #444;
            margin-top: 30px;
        }
        h3 {
            color: #555;
        }
        .feature-info {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-case {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .pass {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }
        .fail {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.2em;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
        }
        .status-pass {
            background-color: #28a745;
        }
        .status-fail {
            background-color: #dc3545;
        }
        .screenshot {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .steps {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .summary h2 {
            color: white;
            margin-top: 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            text-align: center;
        }
        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .summary-number {
            font-size: 2em;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
        }
        .observations {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .observations h2 {
            color: #856404;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Test Report: Login As User (Impersonation)</h1>

    <div class="summary">
        <h2>Test Summary</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-number">6</div>
                <div>Total Tests</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">6</div>
                <div>Passed</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">0</div>
                <div>Failed</div>
            </div>
        </div>
    </div>

    <div class="feature-info">
        <h2>Feature Information</h2>
        <table>
            <tr><th>Feature Name</th><td>Login As User (Impersonation)</td></tr>
            <tr><th>Description</th><td>Impersonate another user with security restrictions and audit logging</td></tr>
            <tr><th>Extension</th><td>Evoq.PersonaBar.Users</td></tr>
            <tr><th>Priority</th><td>Top</td></tr>
            <tr><th>UI Location</th><td>Admin > Users > Select User > More Menu > Login As User</td></tr>
            <tr><th>Test Date</th><td>January 6, 2026</td></tr>
        </table>
    </div>

    <!-- Test Case 1 -->
    <div class="test-case">
        <h2>Test 1: Successfully Impersonate Regular Authorized User</h2>
        <p><span class="status-badge status-pass">PASS</span></p>

        <h3>Description</h3>
        <p>Verify that a SuperUser can successfully impersonate a regular authorized user.</p>

        <div class="steps">
            <h4>Steps Taken</h4>
            <ol>
                <li>Logged in as SuperUser (host)</li>
                <li>Navigated to Admin > Users</li>
                <li>Found Test User123 in the user list</li>
                <li>Clicked the more options menu (three dots)</li>
                <li>Clicked "Login As User" option</li>
                <li>Verified page reloaded and user context changed to Test User123</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <p><strong>Before - Menu showing "Login As User" option:</strong></p>
        <img src="Login_As_User_step01_menu_visible.png" alt="Login As User menu visible" class="screenshot">

        <p><strong>After - Successfully impersonated as Test User123:</strong></p>
        <img src="Login_As_User_step02_impersonation_success.png" alt="Impersonation success" class="screenshot">

        <h3>Result</h3>
        <p class="pass">PASS - Successfully impersonated Test User123. The page reloaded and the user context changed to show "Test User123" in the header. The PersonaBar showed reduced permissions appropriate for a regular user.</p>
    </div>

    <!-- Test Case 2 -->
    <div class="test-case">
        <h2>Test 2: Verify Page Reloads After Impersonation</h2>
        <p><span class="status-badge status-pass">PASS</span></p>

        <h3>Description</h3>
        <p>Verify that the page automatically reloads after successful impersonation to reflect the new user context.</p>

        <div class="steps">
            <h4>Steps Taken</h4>
            <ol>
                <li>Performed impersonation as described in Test 1</li>
                <li>Observed page behavior after clicking "Login As User"</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <img src="Login_As_User_step02_impersonation_success.png" alt="Page reloaded after impersonation" class="screenshot">

        <h3>Result</h3>
        <p class="pass">PASS - The page automatically reloaded after impersonation. The code confirms this with <code>window.top.location.reload()</code> being called after successful impersonation API response.</p>
    </div>

    <!-- Test Case 3 -->
    <div class="test-case">
        <h2>Test 3: Verify Cannot Impersonate Self</h2>
        <p><span class="status-badge status-pass">PASS</span></p>

        <h3>Description</h3>
        <p>Verify that a user cannot impersonate themselves. The "Login As User" option should not appear for the current user.</p>

        <div class="steps">
            <h4>Steps Taken</h4>
            <ol>
                <li>Logged in as SuperUser (host)</li>
                <li>Navigated to Admin > Users</li>
                <li>Searched for "host" to find the current user</li>
                <li>Clicked the more options menu for SuperUser Account</li>
                <li>Verified "Login As User" was NOT in the menu options</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <img src="Login_As_User_step03_no_self_impersonate.png" alt="No Login As User option for self" class="screenshot">

        <h3>Result</h3>
        <p class="pass">PASS - The "Login As User" option is NOT shown for the current user (self). The menu only shows: View Profile, View Assets, Change Password, Force Password Change, Send Password Reset Link. This is enforced by the frontend code: <code>user.userId !== settings.userId</code>.</p>
    </div>

    <!-- Test Case 4 -->
    <div class="test-case">
        <h2>Test 4: Verify Cannot Impersonate SuperUser (Non-SuperUser Check)</h2>
        <p><span class="status-badge status-pass">PASS</span></p>

        <h3>Description</h3>
        <p>Verify that the "Login As User" option does not appear for SuperUser accounts when viewed by non-SuperUser administrators.</p>

        <div class="steps">
            <h4>Steps Taken</h4>
            <ol>
                <li>Reviewed the frontend code in permissionHelpers.js</li>
                <li>Verified the condition: <code>!user.isSuperUser</code> prevents "Login As User" from appearing for SuperUsers</li>
                <li>Reviewed backend code in EvoqUsersController.cs confirming 401 Unauthorized response if non-SuperUser tries to impersonate SuperUser</li>
            </ol>
        </div>

        <h3>Code Evidence</h3>
        <p><strong>Frontend (permissionHelpers.js):</strong></p>
        <pre style="background:#f4f4f4;padding:10px;overflow-x:auto;">
export function canLoginAsUser(settings, user) {
    return (settings.isAdmin || settings.permissions.LOGIN_AS_USER)
        && user.userId !== settings.userId
        && user.authorized && !user.isDeleted && !user.isLocked
        && !user.isSuperUser;  // <-- SuperUsers cannot be impersonated
}</pre>

        <p><strong>Backend (EvoqUsersController.cs):</strong></p>
        <pre style="background:#f4f4f4;padding:10px;overflow-x:auto;">
if ((user.IsSuperUser && !UserInfo.IsSuperUser) || !IsAdmin())
{
    response = Request.CreateErrorResponse(HttpStatusCode.Unauthorized,
        Localization.GetString("InSufficientPermissions", ...));
    return null;
}</pre>

        <h3>Result</h3>
        <p class="pass">PASS - Code review confirms that non-SuperUsers cannot impersonate SuperUser accounts. The frontend prevents the option from appearing, and the backend returns 401 Unauthorized if attempted via API.</p>
    </div>

    <!-- Test Case 5 -->
    <div class="test-case">
        <h2>Test 5: Verify Event Log Entry Created</h2>
        <p><span class="status-badge status-pass">PASS</span></p>

        <h3>Description</h3>
        <p>Verify that an audit log entry is created when a user is impersonated.</p>

        <div class="steps">
            <h4>Steps Taken</h4>
            <ol>
                <li>Performed impersonation of Test User123 (Test 1)</li>
                <li>Logged back in as SuperUser</li>
                <li>Navigated to Manage > Admin Logs</li>
                <li>Found "User Impersonated" log entry</li>
            </ol>
        </div>

        <h3>Evidence</h3>
        <img src="Login_As_User_step06_event_log.png" alt="Event log showing User Impersonated entry" class="screenshot">

        <h3>Result</h3>
        <p class="pass">PASS - The Admin Logs show a "User Impersonated" entry dated 01/06/2026 22:20:29 with Username: host and Summary: "Username testuser123". This confirms audit logging is working correctly. The code confirms: <code>EventLogController.Instance.AddLog("Username", user.Username, PortalSettings, user.UserID, EventLogController.EventLogType.USER_IMPERSONATED);</code></p>
    </div>

    <!-- Test Case 6 -->
    <div class="test-case">
        <h2>Test 6: Verify LOGIN_AS_USER Permission Requirement</h2>
        <p><span class="status-badge status-pass">PASS</span></p>

        <h3>Description</h3>
        <p>Verify that the LOGIN_AS_USER permission is required to impersonate users.</p>

        <div class="steps">
            <h4>Steps Taken</h4>
            <ol>
                <li>Reviewed the backend code for permission requirements</li>
                <li>Verified the AdvancedPermission attribute on the LoginAsUser API method</li>
            </ol>
        </div>

        <h3>Code Evidence</h3>
        <pre style="background:#f4f4f4;padding:10px;overflow-x:auto;">
[HttpPost]
[ValidateAntiForgeryToken]
[AdvancedPermission(MenuName = Components.Constants.MenuName,
                    Permission = Components.Constants.LoginAsUser)]
public HttpResponseMessage LoginAsUser([FromUri] int userId)</pre>

        <h3>Result</h3>
        <p class="pass">PASS - The LOGIN_AS_USER permission is required as confirmed by the <code>[AdvancedPermission]</code> attribute. Additionally, CSRF protection is enforced via <code>[ValidateAntiForgeryToken]</code>.</p>
    </div>

    <!-- Observations Section -->
    <div class="observations">
        <h2>Observations</h2>
        <ul>
            <li><strong>No Deleted Users Available:</strong> The system had no deleted users to test the "cannot impersonate deleted user" scenario. The filter showed "No users found" when set to "Deleted". The code confirms this check exists: <code>!user.isDeleted</code>.</li>
            <li><strong>No Unauthorized/Locked Users Available:</strong> The system had no unauthorized or locked users to test those scenarios. The code confirms these checks exist: <code>user.authorized && !user.isLocked</code>.</li>
            <li><strong>Single SuperUser:</strong> Only one SuperUser (host) exists in the system, so the "SuperUser can impersonate other SuperUser" scenario could not be tested via UI. However, the backend code suggests SuperUsers CAN impersonate other SuperUsers (the user object is returned if both are SuperUsers).</li>
            <li><strong>Frontend vs Backend Logic:</strong> There's a slight discrepancy between frontend and backend - the frontend hides "Login As User" for ALL SuperUsers (<code>!user.isSuperUser</code>), but the backend allows SuperUser-to-SuperUser impersonation. This means even if a SuperUser wanted to impersonate another SuperUser, the UI wouldn't show the option.</li>
            <li><strong>Security Features Verified:</strong>
                <ul>
                    <li>CSRF Token Validation: <code>[ValidateAntiForgeryToken]</code></li>
                    <li>Permission-based Access: <code>[AdvancedPermission]</code></li>
                    <li>Audit Logging: <code>EventLogType.USER_IMPERSONATED</code></li>
                    <li>User Cache Cleared: <code>DataCache.ClearUserCache()</code></li>
                    <li>Current User Logged Out: <code>PortalSecurity.Instance.SignOut()</code></li>
                </ul>
            </li>
        </ul>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; text-align: center;">
        <p>Test Report Generated: January 6, 2026</p>
        <p>Extension: Evoq.PersonaBar.Users | Feature: Login As User (Impersonation)</p>
    </footer>
</body>
</html>
