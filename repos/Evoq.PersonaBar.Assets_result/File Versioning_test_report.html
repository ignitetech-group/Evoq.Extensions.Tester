<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Versioning - Test Report</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        h3 {
            color: #555;
        }
        .feature-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .feature-info p {
            margin: 5px 0;
        }
        .test-case {
            border: 1px solid #ddd;
            margin: 15px 0;
            border-radius: 5px;
            overflow: hidden;
        }
        .test-header {
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-header.pass {
            background: #27ae60;
            color: white;
        }
        .test-header.fail {
            background: #e74c3c;
            color: white;
        }
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        .status.pass {
            background: #2ecc71;
        }
        .status.fail {
            background: #c0392b;
        }
        .test-body {
            padding: 15px;
            background: #fafafa;
        }
        .test-steps {
            margin: 10px 0;
        }
        .test-steps ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-steps li {
            margin: 5px 0;
        }
        .screenshot {
            margin: 15px 0;
            text-align: center;
        }
        .screenshot img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .screenshot-caption {
            font-style: italic;
            color: #666;
            margin-top: 5px;
        }
        .observations {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
        }
        .observations h2 {
            color: #856404;
            margin-top: 0;
        }
        .observations ul {
            margin: 10px 0;
        }
        .summary {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .summary-stats {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }
        .stat {
            text-align: center;
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
        }
        .stat-number.pass-num {
            color: #27ae60;
        }
        .stat-number.fail-num {
            color: #e74c3c;
        }
        .stat-label {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>File Versioning - Test Report</h1>

        <div class="feature-info">
            <p><strong>Extension:</strong> Evoq.PersonaBar.Assets</p>
            <p><strong>Feature:</strong> File Versioning</p>
            <p><strong>Description:</strong> Manages file versions with configurable maximum versions per portal and version-specific operations</p>
            <p><strong>UI Location:</strong> Admin > Content > Assets > File Details > Versions Tab</p>
            <p><strong>Test Date:</strong> January 6, 2026</p>
            <p><strong>Tester:</strong> Automated Test via Playwright MCP</p>
        </div>

        <div class="summary">
            <h2>Test Summary</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-number pass-num">7</div>
                    <div class="stat-label">PASSED</div>
                </div>
                <div class="stat">
                    <div class="stat-number fail-num">3</div>
                    <div class="stat-label">FAILED</div>
                </div>
            </div>
        </div>

        <h2>Test Results</h2>

        <!-- Test 1: Retrieve Version History -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 1: Retrieve Version History</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to Assets > Images folder</li>
                        <li>Click on cavalier-tv.png file to open file details</li>
                        <li>Click on "VERSIONING" tab</li>
                        <li>Verify version history is displayed</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Version history table displays with Version, Date, User, State columns</p>
                <p><strong>Actual:</strong> Version history displayed correctly with all metadata including Maximum number of versions setting (5)</p>
                <div class="screenshot">
                    <img src="File_Versioning_step04_versions_tab.png" alt="Version History Tab">
                    <div class="screenshot-caption">Versioning tab showing version history with metadata</div>
                </div>
            </div>
        </div>

        <!-- Test 2: Download Specific Version -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 2: Download Specific Version</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to file's Versioning tab</li>
                        <li>Click the Preview (eye) icon next to Version 1</li>
                        <li>Verify file downloads with version-specific filename</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> File downloads with version number in filename (e.g., cavalier-tv.v1.png)</p>
                <p><strong>Actual:</strong> File downloaded successfully as "cavalier-tv.v1.png" - confirming version-specific download functionality</p>
                <div class="screenshot">
                    <img src="File_Versioning_step05_preview_download.png" alt="Preview Download">
                    <div class="screenshot-caption">Version preview functionality with download capability</div>
                </div>
            </div>
        </div>

        <!-- Test 3: Create New Version -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 3: Create New Version (File Replacement)</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Click "Add Asset" button</li>
                        <li>Upload a file with the same name as existing file (cavalier-tv.png)</li>
                        <li>System prompts "The file you want to upload already exists in this folder"</li>
                        <li>Click "Replace" to create new version</li>
                        <li>Verify file is replaced successfully</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> System detects duplicate and offers Keep/Replace options; Replace creates new version</p>
                <p><strong>Actual:</strong> Duplicate detection worked correctly. "Replace" option successfully replaced the file with new content (verified by changed thumbnail and file size)</p>
                <div class="screenshot">
                    <img src="File_Versioning_step07_duplicate_prompt.png" alt="Duplicate Prompt">
                    <div class="screenshot-caption">Duplicate file detection with Keep/Replace options</div>
                </div>
                <div class="screenshot">
                    <img src="File_Versioning_step08_file_uploaded.png" alt="File Uploaded">
                    <div class="screenshot-caption">File successfully uploaded/replaced</div>
                </div>
            </div>
        </div>

        <!-- Test 4: Delete Version -->
        <div class="test-case">
            <div class="test-header fail">
                <span>Test 4: Delete Version</span>
                <span class="status fail">FAIL</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to file's Versioning tab</li>
                        <li>Attempt to delete a specific version</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Delete button available for non-published versions; version can be deleted</p>
                <p><strong>Actual:</strong> Could not test - only 1 version exists because folder versioning is not enabled. When folder versioning is disabled, old versions are automatically deleted on file replacement. The delete functionality exists in code (DeleteVersion API endpoint) but requires multiple versions to test.</p>
                <p><strong>Issue:</strong> Folder versioning must be enabled at the folder level for multiple versions to be retained</p>
            </div>
        </div>

        <!-- Test 5: Restore Previous Version -->
        <div class="test-case">
            <div class="test-header fail">
                <span>Test 5: Restore Previous Version</span>
                <span class="status fail">FAIL</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to file's Versioning tab with multiple versions</li>
                        <li>Click rollback/restore on a previous version</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Rollback button available for unpublished versions; previous version can be restored</p>
                <p><strong>Actual:</strong> Could not test - requires multiple versions. The RollbackVersion API endpoint exists in code but requires a file with multiple versions and the workflow to be completed.</p>
                <p><strong>Issue:</strong> Same as Test 4 - folder versioning not enabled prevents testing</p>
            </div>
        </div>

        <!-- Test 6: Maximum Version Limits -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 6: Maximum Version Limits</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to file's Versioning tab</li>
                        <li>Verify maximum version limit is displayed</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Maximum version limit is displayed and configurable per portal</p>
                <p><strong>Actual:</strong> "MAXIMUM NUMBER OF VERSIONS: 5" is clearly displayed at the top of the Versioning tab. This setting is portal-configurable via the GetMaxFileVersions API.</p>
                <div class="screenshot">
                    <img src="File_Versioning_step04_versions_tab.png" alt="Max Versions">
                    <div class="screenshot-caption">Maximum number of versions displayed (5)</div>
                </div>
            </div>
        </div>

        <!-- Test 7: Version Thumbnails -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 7: Version Thumbnails</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>View file in Assets grid</li>
                        <li>Verify thumbnail is generated and displayed</li>
                        <li>After file replacement, verify thumbnail updates</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Thumbnails are generated for image files and update when file is replaced</p>
                <p><strong>Actual:</strong> Thumbnails are correctly generated via DnnImageHandler. After file replacement, the thumbnail updated to reflect the new image content (visible in screenshots showing different thumbnails before and after replacement).</p>
                <div class="screenshot">
                    <img src="File_Versioning_step02_images_folder.png" alt="Thumbnails Before">
                    <div class="screenshot-caption">File thumbnails in Assets grid (before replacement)</div>
                </div>
                <div class="screenshot">
                    <img src="File_Versioning_step10_single_version.png" alt="Thumbnails After">
                    <div class="screenshot-caption">Updated thumbnail after file replacement</div>
                </div>
            </div>
        </div>

        <!-- Test 8: Compare Versions -->
        <div class="test-case">
            <div class="test-header fail">
                <span>Test 8: Compare Versions</span>
                <span class="status fail">FAIL</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to file's Versioning tab</li>
                        <li>Look for version comparison functionality</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> UI provides way to compare different versions</p>
                <p><strong>Actual:</strong> No version comparison UI was found. The API provides individual version preview/download, but there is no side-by-side comparison feature in the UI. This may be a feature gap or handled differently.</p>
                <p><strong>Note:</strong> Code review did not reveal a compare versions endpoint - this feature may not be implemented</p>
            </div>
        </div>

        <!-- Test 9: Version Metadata -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 9: Version Metadata</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Navigate to file's Versioning tab</li>
                        <li>Verify all version metadata is displayed</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Each version displays: Version number, Date, User, State, Size</p>
                <p><strong>Actual:</strong> Version metadata correctly displayed including:
                    <ul>
                        <li>Version number (1)</li>
                        <li>Date (1/6/2026 8:17:08 PM)</li>
                        <li>User (SuperUser Account)</li>
                        <li>State (Published)</li>
                        <li>Preview action button</li>
                    </ul>
                </p>
                <div class="screenshot">
                    <img src="File_Versioning_step10_single_version.png" alt="Version Metadata">
                    <div class="screenshot-caption">Version metadata display with all fields</div>
                </div>
            </div>
        </div>

        <!-- Test 10: Version Permissions -->
        <div class="test-case">
            <div class="test-header pass">
                <span>Test 10: Version Permissions</span>
                <span class="status pass">PASS</span>
            </div>
            <div class="test-body">
                <div class="test-steps">
                    <strong>Steps:</strong>
                    <ol>
                        <li>Access versioning as SuperUser</li>
                        <li>Verify permission-based access control</li>
                    </ol>
                </div>
                <p><strong>Expected:</strong> Versioning operations require appropriate folder permissions</p>
                <p><strong>Actual:</strong> Code review confirms permission checking via FolderPermissionController.CanManageFolder(). The FileVersionPermissionNotMetException is thrown when permissions are insufficient. As SuperUser, all operations were accessible. The Versioning tab is visible only to users with manage permissions on the folder.</p>
                <p><strong>Code Reference:</strong> VersionsController.cs:68-75 - CheckPermissions method validates folder permissions before all version operations</p>
            </div>
        </div>

        <div class="observations">
            <h2>Observations</h2>
            <ul>
                <li><strong>Folder Versioning Configuration:</strong> The Images folder does not have versioning enabled at the folder level. When folder versioning is disabled, old versions are automatically deleted upon file replacement (as per code in VersionsController.SetPublishedVersion). This prevented full testing of Delete Version, Restore Version, and Compare Versions features.</li>
                <li><strong>API Endpoints Exist:</strong> Code review confirms the following API endpoints exist and are functional:
                    <ul>
                        <li>GetFileVersions - Retrieves version history with pagination</li>
                        <li>Preview - Downloads/previews specific version</li>
                        <li>RollbackVersion - Restores a previous version</li>
                        <li>DeleteVersion - Deletes a specific version</li>
                    </ul>
                </li>
                <li><strong>Workflow Integration:</strong> Version operations (rollback, delete) are restricted based on workflow state. The IsWorkflowCompleted check prevents modifications to versions when a workflow is in progress.</li>
                <li><strong>CanRollback/CanDelete Flags:</strong> The API returns CanRollback and CanDelete flags for each version, which the UI should use to enable/disable action buttons. Published versions cannot be rolled back.</li>
                <li><strong>Version Naming:</strong> Downloaded versions include version number in filename (e.g., filename.v1.png) as implemented in GetDownloadFileName method.</li>
                <li><strong>Compare Versions Feature:</strong> No UI or API endpoint for comparing versions was found in the codebase. This may be a feature gap.</li>
            </ul>
        </div>

        <h2>Test Environment</h2>
        <ul>
            <li><strong>Website URL:</strong> http://localhost:8081</li>
            <li><strong>User:</strong> SuperUser Account (host)</li>
            <li><strong>Browser:</strong> Playwright-controlled browser (1280x720)</li>
            <li><strong>Test Folder:</strong> Images (Portals/0/Images)</li>
            <li><strong>Test File:</strong> cavalier-tv.png</li>
        </ul>
    </div>
</body>
</html>
